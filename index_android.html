<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoWeb</title>
    
    <!-- Configura√ß√µes PWA Android -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#15803d">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- √çcone -->
    <link rel="icon" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/2983/2983818.png">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { 
        background-color: #f0fdf4; 
        color: #166534; 
        font-family: Roboto, sans-serif; 
        user-select: none; 
        -webkit-tap-highlight-color: transparent; 
      }
      .spinner { 
        border: 4px solid #dcfce7; 
        width: 40px; 
        height: 40px; 
        border-radius: 50%; 
        border-left-color: #16a34a; 
        animation: spin 1s linear infinite; 
      }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .slide-down { animation: slideDown 0.5s ease-out forwards; }
      @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .bell-shake { animation: shake 2s infinite; transform-origin: top center; }
      @keyframes shake { 0% { transform: rotate(0deg); } 10% { transform: rotate(10deg); } 20% { transform: rotate(-10deg); } 30% { transform: rotate(6deg); } 40% { transform: rotate(-6deg); } 50% { transform: rotate(0deg); } 100% { transform: rotate(0deg); } }
      .pulse-dot { animation: pulse-green 2s infinite; }
      @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
      .fade-in { animation: fadeIn 0.5s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // ======================================================================
      // CONFIGURA√á√ÉO DE CONEX√ÉO
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";
      // ======================================================================

      // Ponte para comunica√ß√£o com a API do Google Apps Script
      const ExternalBridge = {
        request: async (action, payload = {}) => {
          if (!API_URL.startsWith('http')) {
            alert("ERRO: Configure a API_URL no c√≥digo.");
            throw new Error("URL n√£o configurada");
          }
          const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action, ...payload })
          });
          const json = await response.json();
          if (json.error) throw new Error(json.error);
          return json;
        }
      };

      // Mock do objeto 'google' se n√£o estiver rodando no ambiente do Google
      if (typeof google === 'undefined') {
        const createRunner = (success, failure) => {
          return {
            withSuccessHandler: (fn) => createRunner(fn, failure),
            withFailureHandler: (fn) => createRunner(success, fn),
            getBolsistaInfo: (id, token) => ExternalBridge.request('getBolsistaInfo', { id, token }).then(success).catch(failure || console.error),
            registrarPonto: (payload) => ExternalBridge.request('registrarPonto', payload).then(success).catch(failure || console.error)
          };
        };
        window.google = { script: { run: createRunner() } };
      }

      // Biblioteca de √çcones SVG
      const Icon = {
        Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Camera: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Check: () => <svg className="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
        Lock: () => <svg className="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
        Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>,
        Alert: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
        Zap: () => <svg className="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
        Link: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>,
        Download: () => <svg className="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
        LogOut: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
        Calendar: () => <svg className="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
      };

      // --- TELA DE INSTRU√á√ïES DE INSTALA√á√ÉO (ANDROID) ---
      function InstallGuide({ promptEvent }) {
        const install = () => {
          if (promptEvent) {
             promptEvent.prompt();
          } else {
             alert("Toque nos 3 pontos do navegador (‚ãÆ) e selecione 'Adicionar √† tela inicial'.");
          }
        };

        return (
          <div className="fixed inset-0 bg-gray-50 z-50 flex flex-col items-center justify-center p-6 text-center fade-in">
            <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-gray-100">
              <img src="https://cdn-icons-png.flaticon.com/512/2983/2983818.png" className="w-20 h-20 mx-auto mb-6 rounded-2xl shadow-md" />
              <h1 className="text-2xl font-bold text-gray-800 mb-2">Instala√ß√£o Necess√°ria</h1>
              <p className="text-gray-500 mb-8 leading-relaxed">
                Este aplicativo n√£o funciona no navegador. Para garantir o funcionamento correto e acesso offline, instale agora.
              </p>
              
              <button onClick={install} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-green-700 active:scale-95 transition-all flex items-center justify-center">
                <Icon.Download /> Instalar Aplicativo
              </button>
              
              {!promptEvent && (
                <p className="mt-4 text-xs text-gray-400">
                  Caso o bot√£o n√£o funcione, use o menu do Chrome.
                </p>
              )}
            </div>
          </div>
        );
      }

      // --- APP COMPLETO ---
      function TimeClock() {
         const [params, setParams] = useState(null);
         const [bolsistaName, setBolsistaName] = useState('');
         const [lastAction, setLastAction] = useState(null);
         const [entryTime, setEntryTime] = useState(null);
         const [exitTime, setExitTime] = useState(null);
         const [targetHours, setTargetHours] = useState(4);
         const [location, setLocation] = useState(null);
         const [status, setStatus] = useState('loading');
         const [gpsState, setGpsState] = useState('searching');
         const [punchType, setPunchType] = useState(null);
         const [result, setResult] = useState(null);
         const [currentTime, setCurrentTime] = useState(new Date());
         
         const [settingsOpen, setSettingsOpen] = useState(false);
         // Configura√ß√£o agora suporta exitTimeStr para definir sa√≠da manual
         const [notifConfig, setNotifConfig] = useState({ enabled: false, entryTimeStr: '08:00', exitTimeStr: '', reminderMins: 10 });
         const [activeAlert, setActiveAlert] = useState(null);
         const [swRegistration, setSwRegistration] = useState(null);
         const [monitorActive, setMonitorActive] = useState(false);
         const [inputUrl, setInputUrl] = useState('');
         
         const videoRef = useRef(null);
         const lastNotifRef = useRef(null);
         const wakeLockRef = useRef(null);
         const phantomAudioRef = useRef(null);

         // --- SETUP INICIAL ---
         useEffect(() => {
            if ('serviceWorker' in navigator) {
               navigator.serviceWorker.register('./sw.js')
                 .then(reg => setSwRegistration(reg))
                 .catch(e => console.error("SW Erro", e));
            }
            
            const saved = localStorage.getItem('pontoWebConfig');
            if (saved) {
               setNotifConfig(prev => ({...prev, ...JSON.parse(saved)}));
            }
            
            document.addEventListener('visibilitychange', () => {
               if (document.visibilityState === 'visible' && notifConfig.enabled) {
                  startKeepAlive();
               }
            });
         }, []);

         // --- LOOP DE REL√ìGIO E NOTIFICA√á√ïES ---
         useEffect(() => {
            const timer = setInterval(() => { 
               setCurrentTime(new Date()); 
               setMonitorActive(prev => !prev);
            }, 1000);
            
            const notifTimer = setInterval(checkNotifications, 15000); 
            
            return () => { 
               clearInterval(timer); 
               clearInterval(notifTimer); 
            };
         }, [notifConfig, entryTime, lastAction, targetHours, swRegistration]);

         // --- TIMEOUT DE SEGURAN√áA NO LOADING ---
         useEffect(() => {
            if (status === 'loading') {
               const timeout = setTimeout(() => {
                  console.warn("Loading timeout - for√ßando tela de link");
                  localStorage.removeItem('ponto_auth_data'); 
                  setStatus('waiting_link');
               }, 7000); 
               return () => clearTimeout(timeout);
            }
         }, [status]);

         // --- SISTEMA DE ALERTA E √ÅUDIO ---
         const requestWakeLock = async () => { 
            if ('wakeLock' in navigator) { 
               try { 
                  wakeLockRef.current = await navigator.wakeLock.request('screen'); 
               } catch (e) { console.log("WakeLock erro", e); } 
            } 
         };
         
         const startKeepAlive = () => { 
            if (phantomAudioRef.current) { 
               phantomAudioRef.current.volume = 0.05; 
               phantomAudioRef.current.play()
                 .then(() => {
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: 'Monitoramento PontoWeb',
                            artist: 'App Rodando',
                            artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png', sizes: '512x512', type: 'image/png' }]
                        });
                        navigator.mediaSession.setActionHandler('play', () => phantomAudioRef.current.play());
                        navigator.mediaSession.setActionHandler('pause', () => phantomAudioRef.current.play()); 
                    }
                 })
                 .catch(() => {}); 
            } 
            requestWakeLock(); 
         };
         
         const triggerAppAlert = (title, body) => {
             const now = Date.now();
             // Evita alertas repetidos em menos de 5 minutos
             if (body !== 'Teste de Notifica√ß√£o' && lastNotifRef.current && lastNotifRef.current.body === body && (now - lastNotifRef.current.time < 300000)) return;
             
             if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
             
             lastNotifRef.current = { body, time: now };
             setActiveAlert({ title, body }); 
             setTimeout(() => setActiveAlert(null), 15000);
             
             if (swRegistration && swRegistration.showNotification) {
                swRegistration.showNotification(title, { 
                   body, 
                   icon: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png',
                   vibrate: [300, 100, 400],
                   tag: 'pontoweb-alert'
                });
             }
         };

         // === L√ìGICA CORRIGIDA DE NOTIFICA√á√ÉO (ENTRADA E SA√çDA) ===
         const checkNotifications = () => {
             if (!notifConfig.enabled) return;
             
             const now = new Date(); 
             const totalMin = now.getHours() * 60 + now.getMinutes();
             
             // 1. LEMBRETE DE ENTRADA (Se configurado e ainda n√£o entrou)
             if (notifConfig.entryTimeStr && !lastAction) {
                 const [h, m] = notifConfig.entryTimeStr.split(':').map(Number); 
                 const entryTargetMin = h * 60 + m;
                 
                 // Aviso Pr√©vio
                 if (totalMin === (entryTargetMin - notifConfig.reminderMins)) {
                    triggerAppAlert("LEMBRETE ENTRADA", `Faltam ${notifConfig.reminderMins} min para entrar.`);
                 }
                 // Aviso Atraso
                 if (totalMin === (entryTargetMin + 5)) {
                    triggerAppAlert("REGISTRO PENDENTE", "Passaram 5 minutos do hor√°rio de entrada!");
                 }
             }
             
             // 2. LEMBRETE DE SA√çDA (Com Aviso Pr√©vio)
             let exitTargetMin = null;
             
             // Prioridade 1: Hor√°rio Fixo Manual
             if (notifConfig.exitTimeStr) {
                 const [h, m] = notifConfig.exitTimeStr.split(':').map(Number);
                 exitTargetMin = h * 60 + m;
             } 
             // Prioridade 2: C√°lculo Autom√°tico (Entrada Real + Horas Meta)
             else if (entryTime && targetHours) {
                 const [eh, em] = entryTime.split(':').map(Number);
                 exitTargetMin = (eh * 60 + em) + (targetHours * 60);
             }

             // Se temos uma meta de sa√≠da e o usu√°rio ainda n√£o saiu
             if (exitTargetMin && lastAction !== 'Saida') {
                 // Aviso Pr√©vio (Igual ao da Entrada)
                 if (totalMin === (exitTargetMin - notifConfig.reminderMins)) {
                     triggerAppAlert("SA√çDA PR√ìXIMA", `Faltam ${notifConfig.reminderMins} min para completar o dia.`);
                 }
                 
                 // Aviso de Meta Atingida (Hora Exata)
                 if (totalMin === exitTargetMin) {
                     triggerAppAlert("META ATINGIDA", "Hor√°rio cumprido! Pode registrar a sa√≠da.");
                 }
             }
         };

         // --- INTEGRA√á√ÉO COM AGENDA (INTELIGENTE) ---
         const addToCalendar = () => {
            const now = new Date();
            const fmtNum = (n) => String(n).padStart(2, '0');
            let title = "";
            let details = "";
            let dateObj = null;

            // CASO 1: J√Å ENTROU -> Agendar SA√çDA
            if (entryTime && targetHours) {
                const [h, m] = entryTime.split(':').map(Number);
                dateObj = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h + targetHours, m);
                title = "Sa√≠da PontoWeb";
                details = "Hora de registrar a sa√≠da do ponto!";
            } 
            // CASO 2: AINDA N√ÉO ENTROU -> Agendar ENTRADA
            else if (notifConfig.entryTimeStr) {
                const [h, m] = notifConfig.entryTimeStr.split(':').map(Number);
                dateObj = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
                title = "Entrada PontoWeb";
                details = "Hora de registrar a entrada no ponto!";
            } else {
                alert("Configure seu hor√°rio de entrada ou registre o ponto primeiro."); 
                return;
            }
            
            const dateStr = dateObj.getFullYear() + fmtNum(dateObj.getMonth() + 1) + fmtNum(dateObj.getDate());
            const timeStr = fmtNum(dateObj.getHours()) + fmtNum(dateObj.getMinutes()) + '00';
            const startDateTime = `${dateStr}T${timeStr}`;
            
            const endDate = new Date(dateObj.getTime() + 10 * 60000); // 10 min de dura√ß√£o
            const endTimeStr = fmtNum(endDate.getHours()) + fmtNum(endDate.getMinutes()) + '00';
            const endDateTime = `${dateStr}T${endTimeStr}`;

            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDateTime}/${endDateTime}&details=${encodeURIComponent(details)}&sf=true&output=xml`;
            window.open(url, '_blank');
         };

         // --- DATA LOADING & LOGIN ---
         useEffect(() => {
            const u = new URLSearchParams(window.location.search);
            const id = u.get('id');
            const token = u.get('token');
            
            if (id && token) {
               saveAndLogin(id, token);
            } else {
               const s = localStorage.getItem('ponto_auth_data');
               if (s) { 
                 try {
                    const d = JSON.parse(s); 
                    if (d.id && d.token) saveAndLogin(d.id, d.token); 
                    else setStatus('waiting_link');
                 } catch(e) { setStatus('waiting_link'); }
               } else {
                 setStatus('waiting_link');
               }
            }
         }, []);

         const saveAndLogin = (id, token) => {
             setParams({ id, token });
             
             google.script.run.withSuccessHandler(r => {
                 if (r.nome) { 
                    localStorage.setItem('ponto_auth_data', JSON.stringify({ id, token }));
                    setBolsistaName(r.nome); 
                    setEntryTime(r.entryTime); 
                    setExitTime(r.exitTime); 
                    setLastAction(r.lastAction); 
                    setTargetHours(Number(r.horasDia)); 
                    setStatus('ready'); 
                    initGPS(); 
                 } else {
                    localStorage.removeItem('ponto_auth_data');
                    setStatus('waiting_link');
                    if (id && token) alert("Acesso inv√°lido ou expirado.");
                 }
             }).withFailureHandler(() => { 
                 if (status !== 'ready') setStatus('waiting_link'); 
             }).getBolsistaInfo(id, token);
         };

         const initGPS = () => {
             setGpsState('searching');
             navigator.geolocation.getCurrentPosition(
               p => { 
                 setLocation(p.coords); 
                 setGpsState('acquired');
               }, 
               (err) => {
                 console.error("GPS Error", err);
                 setGpsState('denied');
               }, 
               { enableHighAccuracy: true, timeout: 20000 }
             );
         };

         const handleManualLogin = (e) => {
             e.preventDefault();
             try {
                if (inputUrl.includes('?')) {
                   const u = new URL(inputUrl); 
                   const p = new URLSearchParams(u.search);
                   setStatus('loading'); 
                   saveAndLogin(p.get('id'), p.get('token'));
                } else {
                   alert("Link inv√°lido. Certifique-se de copiar o link completo.");
                }
             } catch(err) { alert("Erro ao ler o link."); }
         };

         const logout = () => {
            if (window.confirm("Deseja desconectar esta conta?")) {
                localStorage.removeItem('ponto_auth_data'); 
                setParams(null); 
                setBolsistaName(''); 
                setSettingsOpen(false); 
                setStatus('waiting_link');
            }
         };

         // --- A√á√ïES DO PONTO ---
         const enviarRegistro = () => {
             const canvas = document.createElement('canvas'); 
             canvas.width = 320; 
             canvas.height = 240; 
             const ctx = canvas.getContext('2d');
             
             if (videoRef.current) { 
                ctx.translate(320, 0); 
                ctx.scale(-1, 1); 
                ctx.drawImage(videoRef.current, 0, 0, 320, 240); 
                videoRef.current.srcObject.getTracks().forEach(t => t.stop()); 
             }
             
             setStatus('sending');
             
             google.script.run.withSuccessHandler(r => { 
                if (r.ok) { 
                   setResult(r); 
                   setStatus('success'); 
                } else { 
                   alert("Erro: " + r.msg); 
                   setStatus('ready'); 
                } 
             }).registrarPonto({ 
                pessoaId: params.id, 
                token: params.token, 
                tipo: punchType, 
                lat: location?.latitude, 
                lng: location?.longitude, 
                prec: location?.accuracy, 
                fotoBase64: canvas.toDataURL('image/jpeg', 0.7) 
             });
         };

         const startCamera = async (type) => { 
            setPunchType(type); 
            setStatus('punching'); 
            try { 
               const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); 
               if (videoRef.current) videoRef.current.srcObject = s; 
            } catch(e) { 
               alert("Erro: C√¢mera necess√°ria."); 
               setStatus('ready'); 
            } 
         };

         const testNotification = () => { triggerAppAlert("Teste PontoWeb", "Teste de Notifica√ß√£o"); };

         const saveSettings = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const config = { 
               enabled: notifConfig.enabled, 
               entryTimeStr: formData.get('entryTime'), 
               exitTimeStr: formData.get('exitTime'), // Captura o novo campo
               reminderMins: Number(formData.get('reminderMins')) 
            };
            setNotifConfig(config);
            localStorage.setItem('pontoWebConfig', JSON.stringify(config));
            setSettingsOpen(false);
            if(config.enabled) { startKeepAlive(); playAlert(); }
         };

         // --- RENDERS ---
         
         if (status === 'loading') return (
            <div className="h-screen flex flex-col items-center justify-center bg-gray-50 fade-in">
               <div className="spinner border-green-500 mb-4"></div>
               <p className="text-gray-600 font-medium">Conectando ao sistema...</p>
               <button onClick={()=>{localStorage.removeItem('ponto_auth_data'); setStatus('waiting_link');}} className="text-red-500 text-xs mt-6 underline">
                 Demorando muito? Cancelar e Inserir Link
               </button>
            </div>
         );

         if (status === 'no-link') return (
            <div className="h-screen flex flex-col items-center justify-center p-6 text-center bg-gray-50">
               <div className="bg-white p-6 rounded-2xl shadow-lg border border-red-100 max-w-sm">
                  <h2 className="text-xl font-bold text-gray-800 mb-2">Link Inv√°lido</h2>
                  <p className="text-gray-600 text-sm">Use o link oficial fornecido pelo seu gestor.</p>
               </div>
            </div>
         );

         if (status === 'waiting_link') return (
            <div className="h-screen flex items-center justify-center bg-gray-50 p-6 fade-in">
               <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100">
                  <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                    <Icon.Link />
                  </div>
                  <h2 className="text-xl font-bold text-gray-800 mb-2 text-center">Bem-vindo</h2>
                  <p className="text-sm text-gray-500 mb-4 text-center">Cole seu link de acesso exclusivo abaixo:</p>
                  <form onSubmit={handleManualLogin}>
                     <textarea className="w-full border p-3 mb-4 rounded-xl outline-none focus:border-blue-500 transition-all resize-none bg-gray-50" rows="3" placeholder="https://..." value={inputUrl} onChange={e=>setInputUrl(e.target.value)}></textarea>
                     <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all">Entrar</button>
                  </form>
                  <div className="mt-4 text-xs text-gray-400 text-center">Configura√ß√£o √∫nica.</div>
               </div>
            </div>
         );
         
         if (status === 'success') return (
            <div className="h-screen flex flex-col items-center justify-center p-6 text-center bg-white fade-in">
               <Icon.Check />
               <h2 className="text-2xl font-bold text-green-700 mt-4">Ponto Registrado!</h2>
               <p className="text-4xl font-bold mt-2 text-gray-800">{result.timestamp.split(' ')[1]}</p>
               <p className="text-gray-500 mt-1">{result.status}</p>
               <button onClick={()=>{setResult(null); setStatus('loading'); saveAndLogin(params.id, params.token);}} className="mt-10 bg-green-50 text-green-800 px-8 py-3 rounded-full font-bold shadow-sm border border-green-100">
                 Voltar
               </button>
            </div>
         );

         if (status === 'punching') return (
            <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-50 fade-in">
               <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover scale-x-[-1] opacity-80"></video>
               <div className="absolute bottom-10 w-full px-6 flex gap-4">
                  <button onClick={()=>{if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setStatus('ready');}} className="flex-1 bg-white text-black py-4 rounded-xl font-bold shadow-lg">Cancelar</button>
                  <button onClick={enviarRegistro} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 active:scale-95 transition-transform"><Icon.Camera/> Confirmar</button>
               </div>
               <div className="absolute top-10 text-white font-bold text-xl drop-shadow-md bg-black/30 px-4 py-2 rounded-full backdrop-blur-sm">A registar {punchType}</div>
            </div>
         );

         // L√≥gica de bloqueio de bot√µes
         const isEntryBlocked = lastAction === 'Entrada' || lastAction === 'Intervalo-Fim'; 
         const isExitBlocked = lastAction === 'Saida';
         const isGpsBlocked = gpsState !== 'acquired';

         return (
            <div className="min-h-screen max-w-md mx-auto bg-white shadow-xl flex flex-col relative">
               
               <audio ref={phantomAudioRef} loop preload="auto" src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3"></audio>
               
               {activeAlert && (
                  <div className="fixed top-0 left-0 right-0 z-[100] p-4 slide-down">
                     <div className="bg-white border-l-4 border-orange-500 shadow-2xl rounded-lg p-4 flex items-start gap-3">
                        <div className="text-orange-500 animate-bounce"><Icon.Alert/></div>
                        <div className="flex-1">
                           <h4 className="font-bold text-gray-800 text-lg">{activeAlert.title}</h4>
                           <p className="text-gray-600 font-medium">{activeAlert.body}</p>
                        </div>
                        <button onClick={()=>setActiveAlert(null)} className="text-gray-400 font-bold p-2">‚úï</button>
                     </div>
                  </div>
               )}
               
               <div className={`p-6 text-white text-center rounded-b-3xl shadow-lg z-10 transition-all relative ${gpsState === 'denied' ? 'bg-red-600' : 'bg-green-700'}`}>
                  <button onClick={()=>setSettingsOpen(true)} className="absolute top-4 right-4 text-green-100 hover:text-white bg-white/20 p-2 rounded-full transition-colors"><Icon.Bell/></button>
                  <h1 className="text-2xl font-bold mt-2">PontoWeb Android</h1>
                  <div className="flex flex-col items-center mt-1 mb-1">
                     <span className="text-4xl font-mono font-bold tracking-widest drop-shadow-md">
                        {currentTime.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}
                     </span>
                     <span className="text-xs text-green-100 uppercase tracking-wide font-medium mt-1">
                        {currentTime.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}
                     </span>
                  </div>
                  
                  <div className={`flex justify-center items-center gap-2 text-sm opacity-90 mt-2 py-1 px-3 rounded-full inline-flex ${gpsState === 'denied' ? 'bg-red-800 text-white animate-pulse font-bold' : 'bg-black/20'}`}>
                     <div className="flex items-center gap-2">
                        {notifConfig.enabled && <div className={`w-3 h-3 rounded-full bg-green-300 ${monitorActive ? 'pulse-dot' : ''}`}></div>}
                        {notifConfig.enabled && <Icon.Zap />}
                        <Icon.Map/> 
                     </div>
                     {gpsState === 'searching' ? 'Procurando GPS...' : gpsState === 'denied' ? 'GPS Bloqueado!' : 'Localiza√ß√£o Ativa'}
                  </div>
               </div>

               {status === 'sending' && (
                  <div className="absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm fade-in">
                     <div className="spinner border-green-500 mb-4"></div>
                     <p className="text-green-700 font-bold animate-pulse">Enviando dados...</p>
                  </div>
               )}

               <div className="flex-1 p-6 flex flex-col justify-center gap-4">
                  <div className="text-center mb-2">
                    <p className="text-gray-500 text-xs uppercase tracking-wider mb-1">Bolsista Identificado</p>
                    <div className="flex items-center justify-center gap-2 mb-2">
                        <h3 className="text-xl font-bold text-gray-800">{bolsistaName || 'Carregando...'}</h3>
                        <button onClick={logout} className="bg-gray-100 p-1.5 rounded-full text-gray-400 hover:text-red-500 transition-colors"><Icon.LogOut/></button>
                    </div>
                    <div className="flex gap-2 justify-center mt-2 flex-wrap">
                        {entryTime && <span className="bg-blue-50 text-blue-700 px-3 py-1 text-sm font-bold rounded-full shadow-sm border border-blue-100">Entrada: {entryTime}</span>}
                        {exitTime && <span className="bg-orange-50 text-orange-700 px-3 py-1 text-sm font-bold rounded-full shadow-sm border border-orange-100">Sa√≠da: {exitTime}</span>}
                    </div>
                  </div>
                  
                  {gpsState === 'denied' && (
                     <div className="bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-center text-sm font-bold mb-2">
                        üö´ ATEN√á√ÉO: Ative a localiza√ß√£o do navegador para liberar os bot√µes.
                     </div>
                  )}
                  
                  <button disabled={status!=='ready'||isGpsBlocked||isEntryBlocked} onClick={()=>startCamera('Entrada')} className="bg-green-50 text-green-700 border-2 border-green-200 p-5 rounded-2xl font-bold text-xl hover:bg-green-100 transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm">
                     {isEntryBlocked ? 'ENTRADA (Registrada)' : 'ENTRADA'}
                  </button>
                  
                  <button disabled={status!=='ready'||isGpsBlocked||isExitBlocked} onClick={()=>startCamera('Saida')} className="bg-red-50 text-red-700 border-2 border-red-200 p-5 rounded-2xl font-bold text-xl hover:bg-red-100 transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm">
                     {isExitBlocked ? 'SA√çDA (Registrada)' : 'SA√çDA'}
                  </button>
                  
                  <div className="grid grid-cols-2 gap-4 mt-2">
                     <button disabled={status!=='ready'||isGpsBlocked} onClick={()=>startCamera('Intervalo-Inicio')} className="bg-gray-50 text-gray-700 p-4 rounded-xl font-bold border-2 border-gray-100 hover:bg-gray-100 active:scale-95 disabled:opacity-50">In√≠cio Int.</button>
                     <button disabled={status!=='ready'||isGpsBlocked} onClick={()=>startCamera('Intervalo-Fim')} className="bg-gray-50 text-gray-700 p-4 rounded-xl font-bold border-2 border-gray-100 hover:bg-gray-100 active:scale-95 disabled:opacity-50">Fim Int.</button>
                  </div>
               </div>

               {settingsOpen && (
                  <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 fade-in p-4">
                     <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                        <div className="flex justify-between items-center mb-6 border-b pb-2">
                           <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Icon.Bell/> Configura√ß√µes</h3>
                           <button onClick={()=>setSettingsOpen(false)} className="text-gray-400 text-2xl">&times;</button>
                        </div>
                        
                        <p className="text-sm text-gray-600 mb-6 bg-blue-50 p-3 rounded-lg border border-blue-100">
                           üí° Dica: Se for ouvir m√∫sica, use a op√ß√£o de agendar na Agenda para garantir que n√£o perder√° o hor√°rio.
                        </p>
                        
                        <button onClick={addToCalendar} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mb-3 flex items-center justify-center gap-2 shadow-sm hover:bg-indigo-700 active:scale-95 transition-all">
                           <Icon.Calendar/> 
                           {entryTime ? "Agendar Sa√≠da na Agenda" : "Agendar Entrada na Agenda"}
                        </button>
                        
                        <form onSubmit={saveSettings} className="space-y-4 mb-6">
                           <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Seu Hor√°rio de Entrada (Fixo)</label><input type="time" name="entryTime" defaultValue={notifConfig.entryTimeStr} className="w-full p-3 bg-gray-50 border rounded-xl font-bold text-center text-lg outline-none focus:border-green-500"/></div>
                           <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Seu Hor√°rio de Sa√≠da (Fixo/Opcional)</label><input type="time" name="exitTime" defaultValue={notifConfig.exitTimeStr} className="w-full p-3 bg-gray-50 border rounded-xl font-bold text-center text-lg outline-none focus:border-green-500"/></div>
                           <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Avisar anteced√™ncia (minutos)</label><input type="number" name="reminderMins" defaultValue={notifConfig.reminderMins} min="1" max="60" className="w-full p-3 bg-gray-50 border rounded-xl font-bold text-center text-lg outline-none focus:border-green-500"/></div>
                           
                           <button type="button" onClick={testNotification} className="w-full py-2 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 flex items-center justify-center gap-2 text-sm">üîî Testar Notifica√ß√£o Agora</button>
                           
                           <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all">
                              <Icon.Zap/> Salvar & Ativar Monitoramento
                           </button>
                        </form>
                        
                        <div className="border-t pt-4">
                           <button onClick={logout} className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold border border-red-100 flex items-center justify-center gap-2 active:scale-95 transition-all hover:bg-red-100">
                              <Icon.LogOut/> Desconectar Conta
                           </button>
                        </div>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      function Main() {
        const [isStandalone, setIsStandalone] = useState(false);
        const [promptEvent, setPromptEvent] = useState(null);

        useEffect(() => {
          // Verifica se est√° rodando como app instalado
          if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            setIsStandalone(true);
          }
          // Captura o evento de instala√ß√£o do Chrome
          window.addEventListener('beforeinstallprompt', (e) => { 
             e.preventDefault(); 
             setPromptEvent(e); 
          });
        }, []);

        return isStandalone ? <TimeClock /> : <InstallGuide promptEvent={promptEvent} />;
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<Main />);
    </script>
  </body>
</html>
