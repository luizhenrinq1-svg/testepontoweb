<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoWeb</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#15803d">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { background-color: #f0fdf4; color: #166534; font-family: Roboto, sans-serif; }
      .spinner { border: 4px solid #dcfce7; width: 40px; height: 40px; border-radius: 50%; border-left-color: #16a34a; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .fade-in { animation: fadeIn 0.5s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .slide-down { animation: slideDown 0.5s ease-out forwards; }
      @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .bell-shake { animation: shake 2s infinite; transform-origin: top center; }
      @keyframes shake { 0% { transform: rotate(0deg); } 10% { transform: rotate(10deg); } 20% { transform: rotate(-10deg); } 30% { transform: rotate(6deg); } 40% { transform: rotate(-6deg); } 50% { transform: rotate(0deg); } 100% { transform: rotate(0deg); } }
      .pulse-dot { animation: pulse-green 2s infinite; }
      @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
          return await response.json();
        }
      };

      if (typeof google === 'undefined') {
        window.google = { script: { run: { withSuccessHandler: (s) => ({ withFailureHandler: (f) => ({ getBolsistaInfo: (id, t) => ExternalBridge.request('getBolsistaInfo', { id, t }).then(s).catch(f), registrarPonto: (p) => ExternalBridge.request('registrarPonto', p).then(s).catch(f) }) }) }}};
      }

      const Icon = {
        Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Camera: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Check: () => <svg className="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
        Lock: () => <svg className="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
        Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>,
        Alert: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
        Zap: () => <svg className="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
        Link: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>,
        Download: () => <svg className="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
        LogOut: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
      };

      // --- TELA DE INSTRUÇÕES (ANDROID) ---
      function InstallGuide({ promptEvent }) {
        const install = () => { if (promptEvent) promptEvent.prompt(); else alert("Toque nos 3 pontos do navegador e selecione 'Adicionar à tela inicial'."); };
        return (
          <div className="fixed inset-0 bg-gray-50 z-50 flex flex-col items-center justify-center p-6 text-center fade-in">
            <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-gray-100">
              <img src="https://cdn-icons-png.flaticon.com/512/2983/2983818.png" className="w-20 h-20 mx-auto mb-6 rounded-2xl shadow-md" />
              <h1 className="text-2xl font-bold text-gray-800 mb-2">Instalação Necessária</h1>
              <p className="text-gray-500 mb-8">Este aplicativo não funciona no navegador. Instale para continuar.</p>
              <button onClick={install} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-green-700 active:scale-95 transition-all flex items-center justify-center"><Icon.Download /> Instalar Aplicativo</button>
              {!promptEvent && (<p className="mt-4 text-xs text-gray-400">Ou vá no menu do Chrome ⋮ e "Adicionar à Tela Inicial"</p>)}
            </div>
          </div>
        );
      }

      // --- APP COMPLETO (ATUALIZADO IGUAL IPHONE) ---
      function TimeClock() {
         const [params, setParams] = useState(null);
         const [bolsistaName, setBolsistaName] = useState('');
         const [lastAction, setLastAction] = useState(null);
         const [entryTime, setEntryTime] = useState(null);
         const [exitTime, setExitTime] = useState(null);
         const [targetHours, setTargetHours] = useState(4);
         const [location, setLocation] = useState(null);
         const [status, setStatus] = useState('loading');
         const [gpsState, setGpsState] = useState('searching');
         const [punchType, setPunchType] = useState(null);
         const [result, setResult] = useState(null);
         const [currentTime, setCurrentTime] = useState(new Date());
         const [settingsOpen, setSettingsOpen] = useState(false);
         const [notifConfig, setNotifConfig] = useState({ enabled: false, entryTimeStr: '08:00', reminderMins: 10 });
         const [activeAlert, setActiveAlert] = useState(null);
         const [swRegistration, setSwRegistration] = useState(null);
         const [monitorActive, setMonitorActive] = useState(false);
         const [inputUrl, setInputUrl] = useState('');
         const videoRef = useRef(null);
         const lastNotifRef = useRef(null);
         const titleIntervalRef = useRef(null);
         const wakeLockRef = useRef(null);
         const phantomAudioRef = useRef(null);

         useEffect(() => {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').then(reg => setSwRegistration(reg)).catch(e => {});
            const saved = localStorage.getItem('pontoWebConfig');
            if(saved) setNotifConfig(prev => ({...prev, ...JSON.parse(saved)}));
         }, []);

         useEffect(() => {
            const t = setInterval(() => { setCurrentTime(new Date()); setMonitorActive(prev=>!prev); }, 1000);
            const nt = setInterval(checkNotifications, 15000);
            return () => { clearInterval(t); clearInterval(nt); };
         }, [notifConfig, entryTime, lastAction]);

         // TIMEOUT DE SEGURANÇA NO LOADING
         useEffect(() => {
            if (status === 'loading') {
               const timeout = setTimeout(() => {
                  console.warn("Loading timeout - forçando tela de link");
                  localStorage.removeItem('ponto_auth_data');
                  setStatus('waiting_link');
               }, 7000); 
               return () => clearTimeout(timeout);
            }
         }, [status]);

         // Lógica de GPS, Audio, WakeLock e Notificações
         const requestWakeLock = async () => { if('wakeLock' in navigator) try{ wakeLockRef.current = await navigator.wakeLock.request('screen'); }catch(e){} };
         const startKeepAlive = () => { if(phantomAudioRef.current) { phantomAudioRef.current.volume=0.05; phantomAudioRef.current.play().catch(()=>{}); } requestWakeLock(); };
         
         const triggerAppAlert = (title, body) => {
             const now = Date.now();
             if(body!=='Teste' && lastNotifRef.current && lastNotifRef.current.body===body && (now-lastNotifRef.current.time<300000)) return;
             if(navigator.vibrate) navigator.vibrate([300,100,300]);
             lastNotifRef.current = {body, time:now};
             setActiveAlert({title, body}); setTimeout(()=>setActiveAlert(null), 15000);
             if(swRegistration) swRegistration.showNotification(title, {body, icon:'https://cdn-icons-png.flaticon.com/512/2983/2983818.png'});
         };

         const checkNotifications = () => {
             if(!notifConfig.enabled || !targetHours || !notifConfig.entryTimeStr) return;
             const now = new Date(); const totalMin = now.getHours()*60+now.getMinutes();
             const [h,m] = notifConfig.entryTimeStr.split(':').map(Number); const confMin = h*60+m;
             if(!lastAction && totalMin===(confMin-notifConfig.reminderMins)) triggerAppAlert("LEMBRETE", `Faltam ${notifConfig.reminderMins} min.`);
             if(entryTime && lastAction!=='Saida') {
                 const [eh, em] = entryTime.split(':').map(Number);
                 if((totalMin-(eh*60+em)) === targetHours*60) triggerAppAlert("META", "Horas completas!");
             }
         };

         // Data Loading
         useEffect(() => {
            const u = new URLSearchParams(window.location.search);
            const id = u.get('id'), token = u.get('token');
            if(id && token) saveAndLogin(id, token);
            else {
               const s = localStorage.getItem('ponto_auth_data');
               if(s) { 
                 const d = JSON.parse(s); 
                 if(d.id && d.token) saveAndLogin(d.id, d.token); 
                 else setStatus('waiting_link');
               } else setStatus('waiting_link');
            }
         }, []);

         const saveAndLogin = (id, token) => {
             setParams({ id, token });
             google.script.run.withSuccessHandler(r => {
                 if(r.nome) { 
                    localStorage.setItem('ponto_auth_data', JSON.stringify({id, token}));
                    setBolsistaName(r.nome); setEntryTime(r.entryTime); setExitTime(r.exitTime); setLastAction(r.lastAction); setTargetHours(Number(r.horasDia)); setStatus('ready'); initGPS(); 
                 } else {
                    localStorage.removeItem('ponto_auth_data');
                    setStatus('waiting_link');
                    if(id && token) alert("Acesso inválido.");
                 }
             }).withFailureHandler(() => {
                 if(status !== 'ready') setStatus('waiting_link');
             }).getBolsistaInfo(id, token);
         };

         const initGPS = () => {
             setGpsState('searching');
             navigator.geolocation.getCurrentPosition(p=>{setLocation(p.coords); setGpsState('acquired');}, ()=>setGpsState('denied'), {enableHighAccuracy:true});
         };

         const handleManualLogin = (e) => {
             e.preventDefault();
             try {
                if (inputUrl.includes('?')) {
                   const u = new URL(inputUrl); const p = new URLSearchParams(u.search);
                   setStatus('loading');
                   saveAndLogin(p.get('id'), p.get('token'));
                } else alert("Link inválido.");
             } catch(err) { alert("Erro ao ler link."); }
         };

         const logout = () => {
            if(window.confirm("Deseja desconectar?")) {
                localStorage.removeItem('ponto_auth_data');
                setParams(null);
                setBolsistaName('');
                setSettingsOpen(false);
                setStatus('waiting_link');
            }
         };

         // Actions
         const enviarRegistro = () => {
             const cv = document.createElement('canvas'); cv.width=320; cv.height=240; const ctx = cv.getContext('2d');
             if(videoRef.current) { ctx.translate(320,0); ctx.scale(-1,1); ctx.drawImage(videoRef.current,0,0,320,240); videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); }
             setStatus('sending');
             google.script.run.withSuccessHandler(r => { if(r.ok) { setResult(r); setStatus('success'); } else { alert(r.msg); setStatus('ready'); } }).registrarPonto({ pessoaId: params.id, token: params.token, tipo: punchType, lat: location?.latitude, lng: location?.longitude, prec: location?.accuracy, fotoBase64: cv.toDataURL('image/jpeg', 0.7) });
         };

         const startCamera = async (type) => { setPunchType(type); setStatus('punching'); try{ const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}); if(videoRef.current) videoRef.current.srcObject=s; }catch(e){ alert("Erro Câmera"); setStatus('ready'); } };

         // Renders
         if(status==='loading') return <div className="h-screen flex flex-col items-center justify-center bg-gray-50"><div className="spinner border-green-500 mb-4"></div><p>Carregando...</p><button onClick={()=>{localStorage.removeItem('ponto_auth_data'); setStatus('waiting_link');}} className="text-red-500 text-xs mt-4 underline">Cancelar</button></div>;

         if(status==='waiting_link') return <div className="h-screen flex items-center justify-center bg-gray-50 p-6"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm"><h2 className="text-xl font-bold mb-4">Bem-vindo</h2><p className="text-sm text-gray-500 mb-4">Cole seu link de acesso:</p><textarea className="w-full border p-2 mb-4 rounded" rows="3" placeholder="Link..." onChange={e=>setInputUrl(e.target.value)}></textarea><button onClick={handleManualLogin} className="w-full bg-blue-600 text-white py-2 rounded font-bold">Entrar</button></div></div>;
         
         if(status==='success') return <div className="h-screen flex flex-col items-center justify-center p-6 text-center"><Icon.Check /><h2 className="text-2xl font-bold text-green-700 mt-4">Registrado!</h2><p className="text-xl mt-2">{result.timestamp.split(' ')[1]}</p><button onClick={()=>{setResult(null); setStatus('loading'); saveAndLogin(params.id, params.token);}} className="mt-8 bg-green-100 text-green-800 px-6 py-2 rounded-full font-bold">Voltar</button></div>;

         if(status==='punching') return <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-50"><video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover scale-x-[-1] opacity-80"></video><div className="absolute bottom-10 w-full px-6 flex gap-4"><button onClick={()=>{if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setStatus('ready');}} className="flex-1 bg-white py-4 rounded-xl font-bold">Cancelar</button><button onClick={enviarRegistro} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold">Confirmar</button></div></div>;

         return (
            <div className="min-h-screen max-w-md mx-auto bg-white shadow-xl flex flex-col relative">
               <audio ref={phantomAudioRef} loop src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3"></audio>
               {activeAlert && <div className="fixed top-0 w-full bg-white border-l-4 border-orange-500 p-4 shadow-lg z-50 slide-down flex gap-3"><Icon.Alert/><div className="flex-1 font-bold">{activeAlert.title}<br/><span className="font-normal text-sm">{activeAlert.body}</span></div></div>}
               
               <div className={`p-6 text-white text-center rounded-b-3xl shadow-lg z-10 ${gpsState==='denied'?'bg-red-600':'bg-green-700'}`}>
                  <button onClick={()=>setSettingsOpen(true)} className="absolute top-4 right-4 bg-white/20 p-2 rounded-full"><Icon.Bell/></button>
                  <h1 className="text-2xl font-bold mt-2">PontoWeb Android</h1>
                  <div className="text-4xl font-mono font-bold my-2">{currentTime.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}</div>
                  <div className="flex justify-center gap-2 text-xs bg-black/20 py-1 px-3 rounded-full inline-flex"><Icon.Map/> {gpsState==='acquired'?'Localização Ativa':'Buscando GPS...'}</div>
               </div>

               {status==='sending' && <div className="absolute inset-0 bg-white/90 z-50 flex items-center justify-center"><div className="spinner border-green-500"></div></div>}

               <div className="flex-1 p-6 flex flex-col justify-center gap-4">
                  <div className="text-center mb-2">
                    <p className="text-gray-500 text-xs uppercase tracking-wider mb-1">Bolsista</p>
                    <div className="flex items-center justify-center gap-2">
                        <h3 className="text-xl font-bold">{bolsistaName}</h3>
                        <button onClick={logout} className="bg-gray-100 p-1 rounded-full text-gray-400 hover:text-red-500"><Icon.LogOut/></button>
                    </div>
                    <div className="flex gap-2 justify-center mt-2">
                        {entryTime && <span className="bg-blue-50 text-blue-700 px-2 py-1 text-xs rounded border border-blue-200">E: {entryTime}</span>}
                        {exitTime && <span className="bg-orange-50 text-orange-700 px-2 py-1 text-xs rounded border border-orange-200">S: {exitTime}</span>}
                    </div>
                  </div>
                  
                  <button disabled={status!=='ready'||gpsState!=='acquired'} onClick={()=>startCamera('Entrada')} className="bg-green-50 text-green-800 border-2 border-green-200 p-5 rounded-2xl font-bold text-xl disabled:opacity-50">ENTRADA</button>
                  <button disabled={status!=='ready'||gpsState!=='acquired'} onClick={()=>startCamera('Saida')} className="bg-red-50 text-red-800 border-2 border-red-200 p-5 rounded-2xl font-bold text-xl disabled:opacity-50">SAÍDA</button>
                  <div className="grid grid-cols-2 gap-4">
                     <button disabled={status!=='ready'} onClick={()=>startCamera('Intervalo-Inicio')} className="bg-gray-100 p-4 rounded-xl font-bold disabled:opacity-50">Início Int.</button>
                     <button disabled={status!=='ready'} onClick={()=>startCamera('Intervalo-Fim')} className="bg-gray-100 p-4 rounded-xl font-bold disabled:opacity-50">Fim Int.</button>
                  </div>
               </div>

               {settingsOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-2xl w-full max-w-sm"><h3 className="font-bold text-lg mb-4">Configurações</h3><button onClick={()=>{setNotifConfig(p=>({...p, enabled:true})); startKeepAlive();}} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-4">Ativar Monitoramento</button><button onClick={logout} className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold border border-red-100 flex items-center justify-center gap-2 mb-4"><Icon.LogOut/> Desconectar</button><button onClick={()=>setSettingsOpen(false)} className="w-full py-2 text-gray-500">Fechar</button></div></div>}
            </div>
         );
      }

      function Main() {
        const [isStandalone, setIsStandalone] = useState(false);
        const [promptEvent, setPromptEvent] = useState(null);
        useEffect(() => {
          if (window.matchMedia('(display-mode: standalone)').matches) setIsStandalone(true);
          window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setPromptEvent(e); });
        }, []);
        return isStandalone ? <TimeClock /> : <InstallGuide promptEvent={promptEvent} />;
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<Main />);
    </script>
  </body>
</html>
