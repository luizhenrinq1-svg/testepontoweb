<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoWeb Desktop</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Layout de Desktop */
      body { 
        background-color: #e5e7eb; 
        background-image: radial-gradient(#d1d5db 1px, transparent 1px);
        background-size: 20px 20px;
        color: #166534; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }
      .app-container {
        width: 100%;
        max-width: 400px;
        height: 85vh;
        max-height: 800px;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        background-color: white;
        border: 8px solid #374151; /* Borda cinza escura simulando um dispositivo */
      }
      .spinner { border: 4px solid #dcfce7; width: 40px; height: 40px; border-radius: 50%; border-left-color: #16a34a; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .fade-in { animation: fadeIn 0.3s ease-in; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  </head>
  <body>
    <div id="root" class="app-container"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";
      const PRE_CONFIG_ID = "622bc424";
      const PRE_CONFIG_TOKEN = "f873b36b-042f-4313-b74f-a990ed8edb6f";

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
          return await response.json();
        }
      };

      if (typeof google === 'undefined') {
        const createRunner = (success, failure) => ({
            withSuccessHandler: (fn) => createRunner(fn, failure),
            withFailureHandler: (fn) => createRunner(success, fn),
            getBolsistaInfo: (id, token) => ExternalBridge.request('getBolsistaInfo', { id, token }).then(success).catch(failure || console.error),
            registrarPonto: (payload) => ExternalBridge.request('registrarPonto', payload).then(success).catch(failure || console.error)
        });
        window.google = { script: { run: createRunner() } };
      }

      const Icon = {
        Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Camera: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Check: () => <svg className="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      };

      function TimeClock() {
        const [params, setParams] = useState(null);
        const [bolsistaName, setBolsistaName] = useState('');
        const [entryTime, setEntryTime] = useState(null);
        const [exitTime, setExitTime] = useState(null);
        const [lastAction, setLastAction] = useState(null);
        const [location, setLocation] = useState(null);
        const [status, setStatus] = useState('loading');
        const [gpsState, setGpsState] = useState('searching');
        const [punchType, setPunchType] = useState(null);
        const [result, setResult] = useState(null);
        const [currentTime, setCurrentTime] = useState(new Date()); 
        const videoRef = useRef(null);

        useEffect(() => {
          const u = new URLSearchParams(window.location.search);
          const id = u.get('id') || PRE_CONFIG_ID;
          const token = u.get('token') || PRE_CONFIG_TOKEN;
          if(id && token) {
            setParams({id, token});
            loadBolsista(id, token);
            initGPS();
          } else setStatus('no-link');
          const timer = setInterval(() => setCurrentTime(new Date()), 1000);
          return () => clearInterval(timer);
        }, []);

        const initGPS = () => {
             setGpsState('searching');
             navigator.geolocation.getCurrentPosition(
               p => { setLocation(p.coords); setGpsState('acquired'); }, 
               () => setGpsState('denied'), 
               {enableHighAccuracy:true}
             );
        };

        const loadBolsista = (id, token) => {
             google.script.run.withSuccessHandler(res => {
                if(res.nome) setBolsistaName(res.nome);
                if(res.entryTime) setEntryTime(res.entryTime);
                if(res.exitTime) setExitTime(res.exitTime);
                if(res.lastAction) setLastAction(res.lastAction);
                setStatus('ready');
             }).getBolsistaInfo(id, token);
        };

        const startCamera = async (type) => {
          setPunchType(type); setStatus('punching');
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            if (videoRef.current) videoRef.current.srcObject = stream;
          } catch(e) { alert('Erro: Webcam necessária.'); setStatus('ready'); }
        };

        const confirm = () => {
          const canvas = document.createElement('canvas'); canvas.width = 320; canvas.height = 240;
          const ctx = canvas.getContext('2d');
          if (videoRef.current) {
             ctx.translate(320, 0); ctx.scale(-1, 1);
             ctx.drawImage(videoRef.current, 0, 0, 320, 240); 
             videoRef.current.srcObject.getTracks().forEach(t => t.stop()); 
          }
          setStatus('sending');
          google.script.run.withSuccessHandler((res) => {
             if(res.ok) { setResult(res); setStatus('success'); } else { alert("Erro: " + res.msg); setStatus('ready'); }
          }).registrarPonto({
             pessoaId: params.id, token: params.token, tipo: punchType,
             lat: location?.latitude, lng: location?.longitude, prec: location?.accuracy, fotoBase64: canvas.toDataURL('image/jpeg', 0.7)
          });
        };

        if (status === 'success') return <div className="h-full flex flex-col items-center justify-center bg-white p-6 text-center fade-in"><Icon.Check /><h2 className="text-2xl font-bold mt-4 text-green-700">Ponto Registrado!</h2><p className="text-4xl font-bold mt-2 text-gray-800">{result.timestamp.split(' ')[1]}</p><p className="text-gray-500 mt-1">{result.status}</p><button onClick={() => {setStatus('loading'); loadBolsista(params.id, params.token);}} className="mt-10 px-8 py-3 bg-green-50 text-green-700 font-bold rounded-full border border-green-200 hover:bg-green-50">Voltar</button></div>;
        
        if (status === 'punching') return <div className="absolute inset-0 bg-black flex flex-col items-center justify-center z-50 fade-in"><video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover opacity-80 scale-x-[-1]"></video><div className="absolute bottom-10 w-full px-6 flex gap-4"><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setStatus('ready'); }} className="flex-1 bg-white text-black py-4 rounded-xl font-bold shadow-lg">Cancelar</button><button onClick={confirm} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">Confirmar</button></div></div>;

        const isEntryBlocked = lastAction === 'Entrada' || lastAction === 'Intervalo-Fim'; 
        const isExitBlocked = lastAction === 'Saida';
        const isGpsBlocked = gpsState !== 'acquired';

        return (
          <div className="h-full flex flex-col relative bg-white">
            <div className={`p-6 text-white text-center shadow-lg z-10 transition-all ${gpsState === 'denied' ? 'bg-gray-700' : 'bg-green-700'}`}>
               <h1 className="text-2xl font-bold mt-2">PontoWeb Desktop</h1>
               <div className="flex flex-col items-center mt-1"><span className="text-4xl font-mono font-bold tracking-widest">{currentTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span></div>
               <div className="inline-flex items-center gap-2 bg-black/20 px-3 py-1 rounded-full text-xs mt-2"><Icon.Map /> {gpsState === 'searching' ? 'Aguardando GPS...' : gpsState === 'denied' ? 'Localização Bloqueada' : 'Localização Ativa'}</div>
            </div>

            <div className="flex-1 p-6 flex flex-col justify-center gap-4 overflow-y-auto">
              <div className="text-center mb-4">
                 <h3 className="text-xl font-bold text-gray-800">{bolsistaName || 'Carregando...'}</h3>
                 <div className="flex gap-2 justify-center mt-2">{entryTime && <span className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">Entrada: {entryTime}</span>}{exitTime && <span className="bg-orange-50 text-orange-700 px-3 py-1 rounded-full text-xs font-bold border border-orange-200">Saída: {exitTime}</span>}</div>
              </div>

              <button disabled={status!=='ready' || isGpsBlocked || isEntryBlocked} onClick={() => startCamera('Entrada')} className="bg-green-50 text-green-700 border-2 border-green-200 p-5 rounded-2xl font-bold text-xl hover:bg-green-100 transition-colors disabled:opacity-50">{isEntryBlocked ? 'ENTRADA (OK)' : 'ENTRADA'}</button>
              <button disabled={status!=='ready' || isGpsBlocked || isExitBlocked} onClick={() => startCamera('Saida')} className="bg-red-50 text-red-700 border-2 border-red-200 p-5 rounded-2xl font-bold text-xl hover:bg-red-100 transition-colors disabled:opacity-50">{isExitBlocked ? 'SAÍDA (OK)' : 'SAÍDA'}</button>
              
              <div className="grid grid-cols-2 gap-4 mt-2">
                <button disabled={status!=='ready' || isGpsBlocked} onClick={() => startCamera('Intervalo-Inicio')} className="bg-gray-50 text-gray-700 p-4 rounded-xl font-bold border-2 border-gray-100 hover:bg-gray-100 disabled:opacity-50">Início Int.</button>
                <button disabled={status!=='ready' || isGpsBlocked} onClick={() => startCamera('Intervalo-Fim')} className="bg-gray-50 text-gray-700 p-4 rounded-xl font-bold border-2 border-gray-100 hover:bg-gray-100 disabled:opacity-50">Fim Int.</button>
              </div>
            </div>
            <div className="p-4 text-center text-xs text-gray-300">Versão Desktop</div>
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<TimeClock />);
    </script>
  </body>
</html>