<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoWeb Unespar (PC)</title>
    
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#166534">
    <link rel="apple-touch-icon" href="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true">

    <!-- Dependências -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- CRIPTOGRAFIA (AES) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Firebase (App + Messaging) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <style>
      body { background-color: #eef2f6; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
      .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .spinner { border: 4px solid #e5e7eb; width: 36px; height: 36px; border-radius: 50%; border-left-color: #16a34a; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- SHIM E FIREBASE INIT -->
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";
      const VAPID_KEY = 'BBoKkzbg5v-PjBLtxOv7oQz-o9SEcnpdYu2cAawC_2WHozRfOyYnESz_lss2yA4BGnuO76II-NbwoKUqfaEN-S0';

      const firebaseConfig = {
        apiKey: "AIzaSyCn89LRlH1lksZ811--jb2jlB2iZS5NH1s",
        authDomain: "pontoweb-dc8dd.firebaseapp.com",
        projectId: "pontoweb-dc8dd",
        storageBucket: "pontoweb-dc8dd.firebasestorage.app",
        messagingSenderId: "465750633035",
        appId: "1:465750633035:web:282efd14b807e2a3823bce"
      };

      let messaging = null;
      try {
        firebase.initializeApp(firebaseConfig);
        messaging = firebase.messaging();
      } catch(e) { console.error("Firebase:", e); }

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          const response = await fetch(API_URL, {
            method: 'POST', redirect: "follow",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action, ...payload })
          });
          return await response.json();
        }
      };
      
      if (typeof google === 'undefined') {
        const createShim = (successFn, failureFn) => {
          const execute = (action, params) => {
            ExternalBridge.request(action, params).then(res => { if (successFn) successFn(res); }).catch(err => { if (failureFn) failureFn(err); });
          };
          return {
            withSuccessHandler: (fn) => createShim(fn, failureFn),
            withFailureHandler: (fn) => createShim(successFn, fn),
            getBolsistaInfo: (id, token) => execute('getBolsistaInfo', { id, token }),
            registrarPonto: (p) => execute('registrarPonto', p),
            salvarToken: (p) => execute('salvarToken', p),
            salvarConfiguracao: (p) => execute('salvarConfiguracao', p),
            testarPush: (p) => execute('testarPush', p)
          };
        };
        window.google = { script: { run: createShim(null, null), url: { getLocation: (cb) => { cb({ parameter: {} }); } } } };
      }
      
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(console.error);
    </script>

    <!-- REACT APP LOGIC -->
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      
      // CHAVES DE ARMAZENAMENTO
      const STORAGE_PUBLIC = 'pontoweb_public_info'; 
      const STORAGE_SECURE = 'pontoweb_encrypted_blob'; 
      const CACHE_KEY_DATA = 'pontoweb_user_data_cache';

      // --- COMPONENTE DE ÍCONE SEGURO (LUCIDE) ---
      const LucideIcon = ({ name, size = 18, className = "" }) => {
        const ref = useRef(null);
        useEffect(() => {
          if (ref.current) {
            lucide.createIcons({
              root: ref.current,
              nameAttr: 'data-lucide',
              attrs: { class: className }
            });
          }
        }, [name, size, className]);
        return <span ref={ref} dangerouslySetInnerHTML={{ __html: `<i data-lucide="${name}" width="${size}" height="${size}"></i>` }} style={{ display: 'inline-flex', alignItems: 'center' }} />;
      };

      // --- COMPONENTE MODAL GLOBAL ---
      const Modal = ({ config, onClose }) => {
        if (!config.isOpen) return null;
        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[60] fade-in">
            <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center border border-gray-100 relative transform transition-all scale-100">
               <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${config.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                  <LucideIcon name={config.type === 'error' ? 'triangle-alert' : 'info'} size={32} />
               </div>
               <h3 className="text-xl font-bold text-gray-800 mb-2">{config.title}</h3>
               <p className="text-gray-500 text-sm mb-8">{config.message}</p>
               <div className="flex gap-3">
                 {config.isConfirm && (
                   <button onClick={onClose} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">Cancelar</button>
                 )}
                 <button onClick={() => { if (config.onConfirm) config.onConfirm(); onClose(); }} className={`flex-1 text-white py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 ${config.type === 'error' ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'}`}>
                   {config.confirmText || 'OK'}
                 </button>
               </div>
            </div>
          </div>
        );
      };

      // --- MODAL DE CONFIGURAÇÃO DE NOTIFICAÇÕES ---
      const NotificationModal = ({ isOpen, onClose, initialConfig, onSave }) => {
        const [config, setConfig] = useState(initialConfig || { entrada: '', saida: '', antecedencia: 10 });
        const [permission, setPermission] = useState(Notification.permission);
        const [loading, setLoading] = useState(false);

        useEffect(() => { if (initialConfig) setConfig(initialConfig); }, [initialConfig]);

        const requestPerm = async () => {
           const p = await Notification.requestPermission();
           setPermission(p);
        };

        const handleSave = async () => {
           setLoading(true);
           if (permission !== 'granted') await requestPerm();
           
           // Se deu permissão, tenta pegar o token
           let token = null;
           if (Notification.permission === 'granted' && messaging) {
              try {
                 const reg = await navigator.serviceWorker.ready;
                 token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
              } catch(e) { console.error(e); }
           }
           
           await onSave(config, token);
           setLoading(false);
           onClose();
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70] fade-in">
             <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-gray-100 relative">
                <div className="flex justify-between items-center mb-6">
                   <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><LucideIcon name="bell" /> Alertas</h3>
                   <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><LucideIcon name="x" /></button>
                </div>

                <div className="space-y-4 mb-6">
                   <div className={`p-3 rounded-xl border flex items-center gap-3 ${permission === 'granted' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-orange-50 border-orange-200 text-orange-700'}`}>
                      <LucideIcon name={permission === 'granted' ? 'check-circle' : 'alert-circle'} />
                      <span className="text-xs font-bold">{permission === 'granted' ? 'Notificações Ativas' : 'Permissão Pendente'}</span>
                      {permission !== 'granted' && <button onClick={requestPerm} className="ml-auto text-xs underline">Ativar</button>}
                   </div>

                   <div className="grid grid-cols-2 gap-3">
                      <div>
                         <label className="text-xs font-bold text-gray-400 uppercase">Entrada</label>
                         <input type="time" value={config.entrada} onChange={e => setConfig({...config, entrada: e.target.value})} className="w-full border p-2 rounded-lg font-bold text-gray-700 text-center" />
                      </div>
                      <div>
                         <label className="text-xs font-bold text-gray-400 uppercase">Saída</label>
                         <input type="time" value={config.saida} onChange={e => setConfig({...config, saida: e.target.value})} className="w-full border p-2 rounded-lg font-bold text-gray-700 text-center" />
                      </div>
                   </div>

                   <div>
                      <label className="text-xs font-bold text-gray-400 uppercase">Avisar com Antecedência</label>
                      <select value={config.antecedencia} onChange={e => setConfig({...config, antecedencia: e.target.value})} className="w-full border p-2 rounded-lg bg-white text-gray-700 font-bold">
                         <option value="5">5 minutos antes</option>
                         <option value="10">10 minutos antes</option>
                         <option value="15">15 minutos antes</option>
                         <option value="30">30 minutos antes</option>
                      </select>
                   </div>
                </div>

                <button onClick={handleSave} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg flex justify-center gap-2">
                   {loading ? <div className="spinner w-5 h-5 border-2"></div> : 'Salvar Configuração'}
                </button>
             </div>
          </div>
        );
      };

      function DesktopApp() {
        // --- ESTADOS ---
        const [publicInfo, setPublicInfo] = useState(() => JSON.parse(localStorage.getItem(STORAGE_PUBLIC) || 'null'));
        const [cachedData] = useState(() => JSON.parse(localStorage.getItem(CACHE_KEY_DATA) || 'null'));
        
        const [sessionUser, setSessionUser] = useState(null); 
        const [view, setView] = useState('loading_init'); 
        
        const [bolsistaName, setBolsistaName] = useState(cachedData?.nome || publicInfo?.nome || '');
        const [lastAction, setLastAction] = useState(cachedData?.lastAction || null);
        const [entryTime, setEntryTime] = useState(cachedData?.entryTime || null);
        const [exitTime, setExitTime] = useState(cachedData?.exitTime || null);
        const [location, setLocation] = useState(null);
        const [appStatus, setAppStatus] = useState('ready');
        
        // Notificações
        const [notifConfig, setNotifConfig] = useState(cachedData?.config || { entrada: '', saida: '', antecedencia: 10 });
        const [showNotifModal, setShowNotifModal] = useState(false);

        const [inputUrl, setInputUrl] = useState('');
        const [inputPass, setInputPass] = useState('');
        const [generatedPass, setGeneratedPass] = useState('');
        const [tempCredentials, setTempCredentials] = useState(null); 
        
        const [punchType, setPunchType] = useState(null);
        const [result, setResult] = useState(null);
        const [currentTime, setCurrentTime] = useState(new Date());
        const videoRef = useRef(null);

        // --- MODAL STATES ---
        const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', type: 'info', isConfirm: false });
        const closeModal = () => setModalConfig(prev => ({ ...prev, isOpen: false }));
        const showAlert = (title, message, type = 'info') => setModalConfig({ isOpen: true, title, message, type, isConfirm: false, confirmText: 'Entendi' });
        const showConfirm = (title, message, onConfirm, type = 'info', confirmText = 'Confirmar') => setModalConfig({ isOpen: true, title, message, type, isConfirm: true, onConfirm, confirmText });

        useEffect(() => { const t=setInterval(()=>setCurrentTime(new Date()),1000); return ()=>clearInterval(t); }, []);

        useEffect(() => {
          const encryptedBlob = localStorage.getItem(STORAGE_SECURE);
          if (encryptedBlob && publicInfo) {
             setView('login_password');
          } else {
             const u = new URLSearchParams(window.location.search);
             const uid = u.get('id'), ut = u.get('token');
             if (uid && ut) handleFirstAccess(uid, ut);
             else setView('login_link');
          }
        }, []);

        // --- AUTH ---
        const handleFirstAccess = (id, token) => {
           setView('loading_init');
           google.script.run.withSuccessHandler(res => {
              if (res.error) { showAlert("Erro", res.error, "error"); setView('login_link'); } 
              else {
                 const newPassword = `Bolsista${Math.random().toString(36).slice(-6).toUpperCase()}`;
                 setGeneratedPass(newPassword);
                 setTempCredentials({ id, token, nome: res.nome || 'Bolsista' });
                 setBolsistaName(res.nome);
                 
                 if (res.config) setNotifConfig(res.config); // Carrega config de notificação do backend

                 localStorage.setItem(STORAGE_PUBLIC, JSON.stringify({ nome: res.nome }));
                 setPublicInfo({ nome: res.nome });
                 localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(res));
                 
                 setView('new_password'); 
              }
           }).withFailureHandler(() => { showAlert("Erro", "Falha na conexão.", "error"); setView('login_link'); }).getBolsistaInfo(id, token);
        };

        const confirmPasswordCopy = () => {
           if(!tempCredentials || !generatedPass) return;
           try {
              const encrypted = CryptoJS.AES.encrypt(JSON.stringify(tempCredentials), generatedPass).toString();
              localStorage.setItem(STORAGE_SECURE, encrypted);
              setSessionUser(tempCredentials);
              setTempCredentials(null);
              setGeneratedPass(''); 
              setView('app');
              initGPS();
           } catch(e) { showAlert("Erro", "Criptografia falhou.", "error"); }
        };

        const handlePasswordLogin = (e) => {
           e.preventDefault();
           const encryptedBlob = localStorage.getItem(STORAGE_SECURE);
           if (!encryptedBlob) { showAlert("Erro", "Dados locais perdidos.", "error"); return setView('login_link'); }
           try {
              const bytes = CryptoJS.AES.decrypt(encryptedBlob, inputPass);
              const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
              if (data?.id && data?.token) {
                 setSessionUser(data);
                 setBolsistaName(data.nome);
                 setView('app');
                 loadAppData(data.id, data.token);
                 initGPS();
                 setInputPass(''); 
              } else throw new Error();
           } catch (err) { showAlert("Erro", "Senha incorreta.", "error"); setInputPass(''); }
        };

        const logout = () => {
           showConfirm("Sair?", "Isso removerá a conta deste computador.", () => {
              localStorage.removeItem(STORAGE_PUBLIC);
              localStorage.removeItem(STORAGE_SECURE);
              localStorage.removeItem(CACHE_KEY_DATA);
              setPublicInfo(null);
              setSessionUser(null);
              setInputPass('');
              setView('login_link');
           }, "error", "Sair");
        };

        const handleManualLinkSubmit = (e) => {
           e.preventDefault();
           try {
             if(inputUrl.includes('?')) {
                const u=new URL(inputUrl.startsWith('http')?inputUrl:`http://d.com/${inputUrl}`);
                const p=new URLSearchParams(u.search);
                const id=p.get('id'), token=p.get('token');
                if(id && token) handleFirstAccess(id, token); 
                else showAlert("Erro", "Link incompleto.", "error");
             } else showAlert("Erro", "Link inválido.", "error");
           } catch(err) { showAlert("Erro", "Link inválido.", "error"); }
        };

        // --- APP ---
        const loadAppData = (id, token) => {
           google.script.run.withSuccessHandler(res => {
             if (!res.error) {
                localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(res));
                setEntryTime(res.entryTime||null); setExitTime(res.exitTime||null); setLastAction(res.lastAction||null);
                if (res.config) setNotifConfig(res.config);
             }
           }).getBolsistaInfo(id, token);
        };

        const saveNotificationSettings = async (newConfig, token) => {
           setNotifConfig(newConfig);
           
           // Salva token se foi gerado
           if (token) {
              await ExternalBridge.request('salvarToken', { id: sessionUser.id, token: sessionUser.token, fcmToken: token });
           }
           
           // Salva configurações
           await ExternalBridge.request('salvarConfiguracao', { 
              id: sessionUser.id, token: sessionUser.token, 
              entrada: newConfig.entrada, saida: newConfig.saida, antecedencia: newConfig.antecedencia 
           });
           
           showAlert("Sucesso", "Configurações de alerta salvas e sincronizadas!", "info");
        };

        const initGPS = () => { if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>setLocation(p.coords),console.warn,{enableHighAccuracy:true}); };

        const startCamera = async (type) => {
          setPunchType(type);
          setAppStatus('punching');
          try {
            const s = await navigator.mediaDevices.getUserMedia({video: true});
            if(videoRef.current) videoRef.current.srcObject = s;
          } catch(e) { showAlert("Erro", "Webcam bloqueada.", "error"); setAppStatus('ready'); }
        };

        const confirmPunch = () => {
          const cvs=document.createElement('canvas'); cvs.width=640; cvs.height=480; const ctx=cvs.getContext('2d');
          if(videoRef.current) { ctx.translate(640,0); ctx.scale(-1,1); ctx.drawImage(videoRef.current,0,0,640,480); if(videoRef.current.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); }
          const foto=cvs.toDataURL('image/jpeg',0.8);
          setAppStatus('sending');
          
          google.script.run.withSuccessHandler(res => { 
             if(res.ok) { 
               setResult(res); setAppStatus('success'); 
               const c=JSON.parse(localStorage.getItem(CACHE_KEY_DATA)||'{}'); 
               c.lastAction=punchType;
               if(punchType==='Entrada') c.entryTime=res.timestamp.split(' ')[1].substring(0,5);
               if(punchType==='Saida') c.exitTime=res.timestamp.split(' ')[1].substring(0,5);
               localStorage.setItem(CACHE_KEY_DATA,JSON.stringify(c)); 
               setEntryTime(c.entryTime); setExitTime(c.exitTime); setLastAction(punchType);
             } else { showAlert("Erro", res.msg, "error"); setAppStatus('ready'); } 
          }).withFailureHandler(() => { showAlert("Erro", "Falha conexão.", "error"); setAppStatus('ready'); }).registrarPonto({ pessoaId: sessionUser.id, token: sessionUser.token, tipo: punchType, lat: location?.latitude, lng: location?.longitude, prec: location?.accuracy, fotoBase64: foto });
        };

        if (view === 'loading_init') return <div className="h-screen w-full flex items-center justify-center"><div className="spinner"></div></div>;

        // VIEWS SIMPLIFICADAS PARA ESPAÇO (Mesma lógica de antes para Login/Senha/Sucesso)
        if (view === 'login_link') return ( <> <Modal config={modalConfig} onClose={closeModal} /> <div className="h-screen w-full flex items-center justify-center p-4 bg-gray-50"> <div className="bg-white p-10 rounded-2xl shadow-xl w-full max-w-lg text-center fade-in border border-gray-100 relative"> <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600"><LucideIcon name="map" size={32}/></div> <h1 className="text-2xl font-bold mb-2 text-gray-800">Primeiro Acesso</h1> <p className="text-gray-500 mb-8 text-sm">Cole seu link de acesso pessoal para configurar.</p> <form onSubmit={handleManualLinkSubmit} className="flex gap-2"> <input value={inputUrl} onChange={e=>setInputUrl(e.target.value)} placeholder="Cole o link aqui..." className="flex-1 p-3 border border-gray-300 rounded-lg outline-none focus:border-green-500 transition-colors"/> <button className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors shadow-lg">Configurar</button> </form> </div> </div> </> );
        
        if (view === 'new_password') return ( <> <Modal config={modalConfig} onClose={closeModal} /> <div className="h-screen w-full flex items-center justify-center p-4 bg-green-600/10 backdrop-blur-sm"> <div className="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md text-center fade-in border-2 border-green-500 relative"> <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><LucideIcon name="lock" size={32}/></div> <h2 className="text-2xl font-bold text-gray-800">Senha Segura Criada!</h2> <p className="text-gray-500 text-sm mb-6 mt-2">Anote esta senha. Ela é a única chave para acessar seus dados neste PC.</p> <div className="bg-gray-100 p-4 rounded-xl border border-gray-200 mb-6 flex items-center justify-between group cursor-pointer" onClick={() => navigator.clipboard.writeText(generatedPass)}> <span className="font-mono text-xl font-bold text-gray-800 tracking-wider w-full text-center">{generatedPass}</span> <span className="text-gray-400 group-hover:text-green-600"><LucideIcon name="copy"/></span> </div> <button onClick={confirmPasswordCopy} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 transition-all shadow-lg"> Copiei a senha, pode criptografar </button> </div> </div> </> );

        if (view === 'login_password') return ( <> <Modal config={modalConfig} onClose={closeModal} /> <div className="h-screen w-full flex items-center justify-center p-4 bg-gray-50"> <div className="bg-white p-12 rounded-3xl shadow-xl w-full max-w-md text-center fade-in border border-gray-100"> <div className="mb-6 relative inline-block"> <div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-400 border-4 border-white shadow-sm"><LucideIcon name="user" size={40}/></div> <div className="absolute bottom-0 right-0 bg-green-500 w-6 h-6 rounded-full border-4 border-white"></div> </div> <h1 className="text-2xl font-bold text-gray-800 mb-1">Olá, {publicInfo?.nome?.split(' ')[0]}</h1> <p className="text-gray-400 text-xs mb-8 uppercase tracking-wider">Acesso Seguro (Criptografado)</p> <form onSubmit={handlePasswordLogin}> <div className="relative mb-6"> <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><LucideIcon name="lock" size={20}/></div> <input type="password" value={inputPass} onChange={e => setInputPass(e.target.value)} className="w-full pl-10 pr-4 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-bold text-gray-700" placeholder="Digite sua senha" autoFocus /> </div> <button className="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 transition-all shadow-lg active:scale-95">Desbloquear</button> </form> <button onClick={logout} className="mt-8 text-xs text-gray-400 hover:text-red-500 hover:underline transition-colors"> Não é você? ou Esqueceu a senha? </button> </div> </div> </> );

        if(appStatus==='success') return ( <> <Modal config={modalConfig} onClose={closeModal} /> <div className="h-screen w-full flex items-center justify-center bg-green-50/50"> <div className="bg-white p-12 rounded-3xl shadow-xl text-center fade-in max-w-md w-full border border-gray-100"> <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600"><LucideIcon name="check" size={48}/></div> <h2 className="text-3xl font-bold text-gray-800 mb-2">Ponto Registrado!</h2> <p className="text-gray-500 text-xl font-mono mb-8">{result?.timestamp}</p> <button onClick={() => {setResult(null); setAppStatus('ready');}} className="w-full bg-gray-800 text-white py-4 rounded-xl font-bold hover:bg-black transition-colors shadow-lg">Voltar ao Início</button> </div> </div> </> );

        const isEntryBlocked = lastAction==='Entrada'||lastAction==='Intervalo-Fim';
        const isExitBlocked = lastAction==='Saida';

        return (
          <>
            <Modal config={modalConfig} onClose={closeModal} />
            <NotificationModal isOpen={showNotifModal} onClose={()=>setShowNotifModal(false)} initialConfig={notifConfig} onSave={saveNotificationSettings} />
            
            <div className="h-screen w-full flex items-center justify-center p-4 bg-[#eef2f6]">
              <div className="bg-white w-full h-full rounded-3xl shadow-2xl overflow-hidden flex fade-in border border-gray-100 relative">
                
                {/* SIDEBAR */}
                <div className="w-80 bg-slate-50 p-10 flex flex-col border-r border-gray-100 relative z-10 shrink-0">
                   {/* CABEÇALHO DO SIDEBAR MODIFICADO */}
                   <div className="mb-10 flex items-center gap-4">
                      <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true" className="w-20 h-20 object-contain"/>
                      <div className="flex flex-col justify-center -mt-2">
                         <h1 className="text-3xl font-bold text-green-700 tracking-tight leading-none">PontoWeb</h1>
                         <p className="text-gray-400 text-xs font-medium tracking-wider uppercase mt-1">Versão PC 3.1</p>
                      </div>
                   </div>
                   
                   <div className="bg-white p-6 rounded-2xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] border border-gray-100 mb-6">
                      <div className="flex items-center gap-3 mb-4 border-b border-gray-50 pb-4">
                          <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 flex-shrink-0"><LucideIcon name="user" size={20}/></div>
                          <div className="min-w-0">
                              <p className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Bolsista</p>
                              <h2 className="text-base font-bold text-gray-800 leading-tight break-words">{bolsistaName}</h2>
                          </div>
                      </div>
                      <div className="space-y-3">
                         <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                             <span className="text-xs font-semibold text-gray-500">Entrada</span> 
                             <span className="font-mono font-bold text-green-700">{entryTime || '--:--'}</span>
                         </div>
                         <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                             <span className="text-xs font-semibold text-gray-500">Saída</span> 
                             <span className="font-mono font-bold text-red-700">{exitTime || '--:--'}</span>
                         </div>
                      </div>
                   </div>

                   <div className="mt-auto space-y-3">
                      <button onClick={() => setShowNotifModal(true)} className="w-full bg-blue-50 border border-blue-100 text-blue-600 hover:bg-blue-100 hover:text-blue-700 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-sm">
                         <LucideIcon name="bell" size={16}/> Meus Alertas
                      </button>
                      
                      <div className="text-xs text-gray-400 flex items-center gap-2 px-2 pt-2 justify-center">
                         <LucideIcon name="map-pin" size={12}/> {location ? 'GPS Calibrado' : 'Buscando Localização...'}
                      </div>
                      
                      <button onClick={() => { setSessionUser(null); setInputPass(''); setView('login_password'); }} className="w-full bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-800 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-sm">
                         Bloquear Tela
                      </button>
                   </div>
                </div>

                {/* MAIN AREA */}
                <div className="flex-1 p-12 relative flex flex-col bg-white overflow-hidden">
                   
                   {/* BACKGROUND LOGO - MARCA D'ÁGUA */}
                   <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                      <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Logo.png?raw=true" className="w-[70vh] h-[70vh] object-contain opacity-[0.05]" />
                   </div>

                   <div className="mb-4 relative z-10">
                      <p className="text-gray-400 text-lg font-medium capitalize">{currentTime.toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'long'})}</p>
                      <div className="flex items-center gap-4">
                        <p className="text-7xl font-bold text-slate-800 font-mono tracking-tighter mt-1">
                             {currentTime.toLocaleTimeString('pt-BR').substring(0,5)}
                             <span className="text-3xl text-gray-300 ml-1 font-normal">{currentTime.getSeconds().toString().padStart(2,'0')}</span>
                        </p>
                        <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Logo.png?raw=true" className="w-0 h-0 object-contain drop-shadow-sm -mt-6 ml-12" />
                      </div>
                   </div>

                   {appStatus === 'punching' ? (
                      <div className="flex-1 flex flex-col items-center justify-center bg-slate-900 rounded-3xl overflow-hidden relative shadow-2xl z-10">
                         <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover scale-x-[-1] opacity-90"></video>
                         <div className="absolute bottom-8 flex gap-4 w-full px-8 z-10">
                            <button onClick={()=>{if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setAppStatus('ready');}} className="bg-white/90 backdrop-blur text-gray-800 px-8 py-4 rounded-2xl font-bold shadow-lg hover:bg-white flex-1 transition-all">Cancelar</button>
                            <button onClick={confirmPunch} className="bg-green-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg hover:bg-green-500 flex-[2] flex justify-center items-center gap-3 transition-all"><LucideIcon name="camera" size={20}/> Registrar {punchType}</button>
                         </div>
                      </div>
                   ) : (
                      <div className="grid grid-cols-2 gap-4 flex-1 content-center max-w-3xl mx-auto w-full relative z-10">
                         <button disabled={isEntryBlocked || !location} onClick={()=>startCamera('Entrada')} className="group h-36 relative overflow-hidden bg-gradient-to-br from-green-50 to-green-100/50 border border-green-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:hover:translate-y-0 disabled:shadow-none">
                            <div className="w-12 h-12 bg-white text-green-600 rounded-full flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform"><LucideIcon name="check" size={28}/></div>
                            <span className="text-xl font-bold text-green-800 tracking-tight">REGISTRAR ENTRADA</span>
                         </button>
                         
                         <button disabled={isExitBlocked || !location} onClick={()=>startCamera('Saida')} className="group h-36 relative overflow-hidden bg-gradient-to-br from-red-50 to-red-100/50 border border-red-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:shadow-md hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:hover:translate-y-0 disabled:shadow-none">
                            <div className="w-12 h-12 bg-white text-red-600 rounded-full flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform"><LucideIcon name="log-out" size={28}/></div>
                            <span className="text-xl font-bold text-red-800 tracking-tight">REGISTRAR SAÍDA</span>
                         </button>
                         
                         <button disabled={!location} onClick={()=>startCamera('Intervalo-Inicio')} className="h-20 bg-white border border-slate-200 rounded-xl font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-700 hover:bg-slate-50 transition-all text-sm uppercase tracking-wide">
                             INÍCIO INTERVALO
                         </button>
                         
                         <button disabled={!location} onClick={()=>startCamera('Intervalo-Fim')} className="h-20 bg-white border border-slate-200 rounded-xl font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-700 hover:bg-slate-50 transition-all text-sm uppercase tracking-wide">
                             FIM INTERVALO
                         </button>
                      </div>
                   )}
                </div>
              </div>
            </div>
          </>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<DesktopApp />);
    </script>
  </body>
</html>
