<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoWeb</title>
    
    <!-- Configura√ß√µes PWA (Necess√°rio para Instalar) -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2983/2983818.png">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { background-color: #f0fdf4; color: #166534; font-family: sans-serif; user-select: none; }
      .spinner { border: 4px solid #dcfce7; width: 40px; height: 40px; border-radius: 50%; border-left-color: #16a34a; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .fade-in { animation: fadeIn 0.3s ease-in; }
      @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      .slide-down { animation: slideDown 0.5s ease-out forwards; }
      @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .bell-shake { animation: shake 2s infinite; transform-origin: top center; }
      @keyframes shake { 0% { transform: rotate(0deg); } 10% { transform: rotate(10deg); } 20% { transform: rotate(-10deg); } 30% { transform: rotate(6deg); } 40% { transform: rotate(-6deg); } 50% { transform: rotate(0deg); } 100% { transform: rotate(0deg); } }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // ======================================================================
      // CONFIGURA√á√ÉO DE HOSPEDAGEM EXTERNA (GitHub / Vercel / Netlify)
      // Cole a URL do seu Web App do Google Apps Script (terminada em /exec) aqui:
      const API_URL = "https://script.google.com/macros/s/AKfycbz7poveyTAAUUdqi1fWEgGTE3eRXWqizE3n5Dx0fMkkMdAsWp-Q_PYrSh7EzO07dXydVA/exec"; 
      // ======================================================================

      // Arquivo de √°udio silencioso para manter o app acordado (Keep Alive)
      const SILENT_AUDIO = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTSVMAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjU0AAAAAAAAAAAAAAAAJAAAAAAAAAAAASAAVrGhAAAAAAAAAAAAAAAAAAAAAP/7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYaW5nAAAADwAAAAQAAAEgOTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk5//uQZAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAAAABDQEAAAMAAABPAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//7kGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB";

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          if (!API_URL.startsWith('http')) {
            alert("ERRO: Configure a API_URL no c√≥digo.");
            throw new Error("URL n√£o configurada");
          }
          const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action, ...payload })
          });
          const json = await response.json();
          if (json.error) throw new Error(json.error);
          return json;
        }
      };

      if (typeof google === 'undefined') {
        const createRunner = (success, failure) => {
          return {
            withSuccessHandler: (fn) => createRunner(fn, failure),
            withFailureHandler: (fn) => createRunner(success, fn),
            getBolsistaInfo: (id, token) => ExternalBridge.request('getBolsistaInfo', { id, token }).then(success).catch(failure || console.error),
            registrarPonto: (payload) => ExternalBridge.request('registrarPonto', payload).then(success).catch(failure || console.error)
          };
        };
        window.google = { script: { run: createRunner() } };
      }

      const Icon = {
        Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Camera: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Check: () => <svg className="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
        Lock: () => <svg className="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
        Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>,
        Alert: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
        Zap: () => <svg className="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      };

      function TimeClock() {
        const [params, setParams] = useState(null);
        const [bolsistaName, setBolsistaName] = useState('');
        const [lastAction, setLastAction] = useState(null);
        const [entryTime, setEntryTime] = useState(null);
        const [targetHours, setTargetHours] = useState(4); 
        const [location, setLocation] = useState(null);
        const [status, setStatus] = useState('loading');
        const [punchType, setPunchType] = useState(null);
        const [result, setResult] = useState(null);
        const [currentTime, setCurrentTime] = useState(new Date()); 
        
        // Estado das Notifica√ß√µes & PWA
        const [settingsOpen, setSettingsOpen] = useState(false);
        const [notifConfig, setNotifConfig] = useState({
          enabled: false,
          entryTimeStr: '08:00',
          reminderMins: 10
        });
        const [activeAlert, setActiveAlert] = useState(null);
        const [swRegistration, setSwRegistration] = useState(null);
        const [installPrompt, setInstallPrompt] = useState(null); // Estado para o bot√£o de instala√ß√£o

        const videoRef = useRef(null);
        const lastNotifRef = useRef(null); 
        const titleIntervalRef = useRef(null);
        const wakeLockRef = useRef(null);
        const silentAudioRef = useRef(null); // Ref para o √°udio "Keep Alive"

        // --- INICIALIZA√á√ÉO E SERVICE WORKER ---
        useEffect(() => {
          // Inicializa o elemento de √°udio silencioso
          const audio = new Audio(SILENT_AUDIO);
          audio.loop = true;
          silentAudioRef.current = audio;

          // 1. Tenta recuperar Configura√ß√µes
          const saved = localStorage.getItem('pontoWebConfig');
          if (saved) {
            const config = JSON.parse(saved);
            setNotifConfig(prev => ({...prev, ...config}));
            if(config.enabled) {
               requestWakeLock();
               // Nota: Audio s√≥ toca ap√≥s intera√ß√£o do usu√°rio, tratamos no bot√£o
            }
          }

          // 2. Registrar Service Worker (Real do GitHub)
          if ('serviceWorker' in navigator) {
             navigator.serviceWorker.register('./sw.js')
               .then(reg => {
                 console.log('SW Registrado:', reg);
                 setSwRegistration(reg);
               })
               .catch(err => console.log('SW Falha:', err));
          }

          // 3. Capturar evento de instala√ß√£o do PWA
          window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // Impede o mini-infobar autom√°tico
            setInstallPrompt(e); // Guarda o evento para usar no bot√£o
          });
        }, []);

        useEffect(() => {
          const timer = setInterval(() => setCurrentTime(new Date()), 1000);
          const notifTimer = setInterval(checkNotifications, 15000); 
          return () => { clearInterval(timer); clearInterval(notifTimer); releaseWakeLock(); };
        }, [notifConfig, entryTime, lastAction, targetHours, swRegistration]);

        const requestWakeLock = async () => {
          if ('wakeLock' in navigator) {
            try { wakeLockRef.current = await navigator.wakeLock.request('screen'); } catch (err) {}
          }
        };

        const releaseWakeLock = () => {
          if (wakeLockRef.current) { wakeLockRef.current.release(); wakeLockRef.current = null; }
        };

        const startKeepAlive = () => {
           // Toca √°udio silencioso para enganar o gerenciador de bateria do Android
           if(silentAudioRef.current) {
              silentAudioRef.current.play().catch(e => console.log("Audio play prevented:", e));
           }
           requestWakeLock();
        };

        // --- DATA LOADING & PERSIST√äNCIA (Login Autom√°tico) ---
        useEffect(() => {
          const u = new URLSearchParams(window.location.search);
          let id = u.get('id');
          let token = u.get('token');

          // Salva ou Recupera Credenciais
          if (id && token) {
             localStorage.setItem('ponto_auth_data', JSON.stringify({ id, token }));
          } else {
             const savedAuth = localStorage.getItem('ponto_auth_data');
             if (savedAuth) {
                const auth = JSON.parse(savedAuth);
                id = auth.id;
                token = auth.token;
             }
          }

          if (id && token) {
            setParams({ id, token });
            google.script.run.withSuccessHandler(res => {
               if(res.nome) setBolsistaName(res.nome);
               if(res.entryTime) setEntryTime(res.entryTime);
               if(res.lastAction) setLastAction(res.lastAction);
               if(res.horasDia) setTargetHours(Number(res.horasDia));
               setStatus('ready');
            }).getBolsistaInfo(id, token);
            navigator.geolocation.getCurrentPosition(p => setLocation(p.coords), () => {}, {enableHighAccuracy:true});
          } else {
             setStatus('no-link');
          }
        }, []);

        // --- SISTEMA DE NOTIFICA√á√ÉO 4.0 (Service Worker Push) ---
        const startTitleBlink = (msg) => {
          if (titleIntervalRef.current) clearInterval(titleIntervalRef.current);
          let isOriginal = false;
          const originalTitle = "Bater Ponto";
          document.title = msg;
          titleIntervalRef.current = setInterval(() => {
            document.title = isOriginal ? msg : "üîî üîî üîî";
            isOriginal = !isOriginal;
          }, 1000);
          const stopBlink = () => {
            clearInterval(titleIntervalRef.current);
            document.title = originalTitle;
            window.removeEventListener('mousemove', stopBlink);
            window.removeEventListener('touchstart', stopBlink);
          };
          window.addEventListener('mousemove', stopBlink);
          window.addEventListener('touchstart', stopBlink);
        };

        const playAlert = () => {
          if (navigator.vibrate) navigator.vibrate([1000, 500, 1000, 500, 1000]);
          try {
            const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
            audio.volume = 1.0;
            audio.play().catch(() => {});
          } catch (e) {}
        };

        const triggerAppAlert = (title, body) => {
           const now = Date.now();
           if (body !== 'Teste de Notifica√ß√£o' && lastNotifRef.current && lastNotifRef.current.body === body && (now - lastNotifRef.current.time < 300000)) return;

           playAlert();
           startTitleBlink(`‚ö†Ô∏è ${title}`);
           lastNotifRef.current = { body, time: now };

           // TENTA USAR O SERVICE WORKER (Melhor para Android)
           if (Notification.permission === 'granted' && swRegistration) {
              try {
                swRegistration.showNotification(title, {
                  body: body,
                  icon: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png',
                  vibrate: [300, 100, 400],
                  tag: 'pontoweb-alert',
                  renotify: true, // For√ßa vibrar de novo
                  requireInteraction: true // For√ßa ficar na tela
                });
              } catch(e) { console.log('Erro SW Notif:', e); fallbackNotification(title, body); }
           } else {
             fallbackNotification(title, body);
           }

           setActiveAlert({ title, body });
           setTimeout(() => setActiveAlert(null), 15000); 
        };

        const fallbackNotification = (title, body) => {
           if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
             try { new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png' }); } catch(e){}
           }
        };

        const checkNotifications = () => {
          if (!notifConfig.enabled || !targetHours) return;
          const now = new Date();
          const currentHours = now.getHours();
          const currentMins = now.getMinutes();
          const totalCurrentMins = currentHours * 60 + currentMins;

          if(!notifConfig.entryTimeStr) return;
          const [confH, confM] = notifConfig.entryTimeStr.split(':').map(Number);
          const totalConfigMins = confH * 60 + confM;
          
          const reminderThreshold = totalConfigMins - notifConfig.reminderMins;
          if (!lastAction && totalCurrentMins === reminderThreshold) {
             triggerAppAlert("LEMBRETE PONTO", `Faltam ${notifConfig.reminderMins} minutos.`);
          }
          if (!lastAction && totalCurrentMins >= totalConfigMins + 5 && totalCurrentMins < totalConfigMins + 10) {
             triggerAppAlert("REGISTRO PENDENTE", "Passaram 5 minutos do hor√°rio!");
          }
          if (entryTime && lastAction !== 'Saida') {
             const [entryH, entryM] = entryTime.split(':').map(Number);
             const entryTotal = entryH * 60 + entryM;
             const workedMins = totalCurrentMins - entryTotal; 
             const targetMins = targetHours * 60;
             if (workedMins >= targetMins && workedMins < targetMins + 5) { 
                triggerAppAlert("META ATINGIDA", `Voc√™ completou ${targetHours} horas.`);
             }
          }
        };

        const enableAlerts = () => {
          if (!("Notification" in window)) { alert("Navegador sem suporte."); return; }
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              setNotifConfig(prev => ({...prev, enabled: true}));
              startKeepAlive(); // ATIVA O MODO SENTINELA
              playAlert();
              // Teste Imediato com SW se dispon√≠vel
              if(swRegistration) {
                 swRegistration.showNotification("PontoWeb", { body: "Notifica√ß√µes e Modo Sentinela Ativados!", icon: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png', vibrate: [200,100,200] });
              } else {
                 new Notification("PontoWeb", { body: "Notifica√ß√µes Ativadas!" });
              }
            } else {
              alert("Notifica√ß√µes bloqueadas. Verifique as configura√ß√µes do navegador.");
              setNotifConfig(prev => ({...prev, enabled: true})); // Ativa modo interno
            }
          });
        };

        const installPWA = () => {
           if(installPrompt) {
              installPrompt.prompt();
              installPrompt.userChoice.then(res => setInstallPrompt(null));
           } else {
              alert("Para instalar: Abra o menu do navegador e procure por 'Adicionar √† Tela Inicial' ou 'Instalar Aplicativo'.");
           }
        };

        const testNotification = () => {
           triggerAppAlert("Teste PontoWeb", "Teste de Notifica√ß√£o");
        };

        const saveSettings = (e) => {
           e.preventDefault();
           const formData = new FormData(e.target);
           const config = {
             enabled: notifConfig.enabled,
             entryTimeStr: formData.get('entryTime'),
             reminderMins: Number(formData.get('reminderMins'))
           };
           setNotifConfig(config);
           localStorage.setItem('pontoWebConfig', JSON.stringify(config));
           setSettingsOpen(false);
           if(config.enabled) {
             startKeepAlive();
             playAlert();
           }
        };

        // --- A√á√ïES DO SISTEMA ---
        const resetState = () => {
           setResult(null); setPunchType(null); setStatus('loading');
           if (params) loadBolsista(params.id, params.token);
           initGPS();
        };

        const startCamera = async (type) => {
          setPunchType(type); setStatus('punching');
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            if (videoRef.current) videoRef.current.srcObject = stream;
          } catch(e) { alert('Erro: C√¢mera necess√°ria.'); setStatus('ready'); }
        };

        const confirm = () => {
          const canvas = document.createElement('canvas');
          canvas.width = 320; canvas.height = 240;
          const ctx = canvas.getContext('2d');
          if (videoRef.current) {
             ctx.drawImage(videoRef.current, 0, 0, 320, 240);
             const stream = videoRef.current.srcObject;
             if (stream) stream.getTracks().forEach(t => t.stop());
          }
          const foto = canvas.toDataURL('image/jpeg', 0.7);
          setStatus('sending');
          const payload = {
            pessoaId: params.id, token: params.token, tipo: punchType,
            lat: location?.latitude, lng: location?.longitude, prec: location?.accuracy, fotoBase64: foto
          };
          google.script.run.withSuccessHandler((res) => {
               if(res.ok) { setResult(res); setStatus('success'); } 
               else { alert("Erro: " + res.msg); setStatus('ready'); }
            }).withFailureHandler((err) => { alert("Erro de servidor: " + err.message); setStatus('ready'); })
            .registrarPonto(payload);
        };

        // Telas
        if (status === 'no-link') return <div className="h-screen flex items-center justify-center p-4 text-center"><div><h1 className="text-xl font-bold text-red-600">Link Inv√°lido</h1><p className="text-gray-600 mt-2">Use o link fornecido pelo gestor.</p></div></div>;
        if (status === 'success') return <div className="h-screen flex flex-col items-center justify-center bg-white p-6 text-center fade-in"><Icon.Check /><h2 className="text-2xl font-bold mt-4 text-green-700">Ponto Registrado!</h2><p className="text-4xl font-bold mt-2 text-gray-800">{result.timestamp.split(' ')[1]}</p><p className="text-gray-500 mt-1">{result.status}</p><button onClick={resetState} className="mt-10 px-8 py-3 bg-green-50 text-green-700 font-bold rounded-full hover:bg-green-100 shadow-sm">Voltar</button></div>;
        if (status === 'punching') return <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-50 fade-in"><video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover opacity-80"></video><div className="absolute bottom-10 w-full px-6 flex gap-4"><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setStatus('ready'); }} className="flex-1 bg-white text-black py-4 rounded-xl font-bold shadow-lg">Cancelar</button><button onClick={confirm} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 active:scale-95 transition-transform"><Icon.Camera/> Confirmar</button></div><div className="absolute top-10 text-white font-bold text-xl drop-shadow-md bg-black/30 px-4 py-2 rounded-full backdrop-blur-sm">A registar {punchType}</div></div>;

        return (
          <div className="min-h-screen max-w-md mx-auto bg-white shadow-xl flex flex-col relative">
            
            {/* ALERTA VISUAL */}
            {activeAlert && (
              <div className="fixed top-0 left-0 right-0 z-[100] p-4 slide-down">
                <div className="bg-white border-l-4 border-orange-500 shadow-2xl rounded-lg p-4 flex items-start gap-3">
                  <div className="text-orange-500 animate-bounce"><Icon.Alert /></div>
                  <div className="flex-1">
                    <h4 className="font-bold text-gray-800 text-lg">{activeAlert.title}</h4>
                    <p className="text-gray-600 font-medium">{activeAlert.body}</p>
                  </div>
                  <button onClick={() => setActiveAlert(null)} className="text-gray-400 font-bold p-2">‚úï</button>
                </div>
              </div>
            )}

            <div className="bg-green-600 p-6 text-white text-center rounded-b-3xl shadow-lg z-10 transition-all relative">
              
              {/* BOT√ÉO INSTALAR PWA (Restaurado e Corrigido) */}
              <div className="absolute top-4 left-4 cursor-pointer z-20" onClick={installPWA}>
                 <div className="bg-green-700/50 p-2 rounded-full text-xs flex items-center gap-1 hover:bg-green-500 transition-colors border border-green-500/30">
                   <span>üì≤</span> {installPrompt ? 'Instalar App' : 'App PWA'}
                 </div>
              </div>

              {/* Bot√£o Configura√ß√µes */}
              <button onClick={() => setSettingsOpen(true)} className={`absolute top-4 right-4 text-green-100 hover:text-white bg-green-700/50 p-2 rounded-full ${notifConfig.enabled ? 'bell-shake' : ''}`}>
                 <Icon.Bell />
                 {notifConfig.enabled && <span className="absolute top-0 right-0 w-3 h-3 bg-red-400 rounded-full border-2 border-green-600"></span>}
              </button>

              <h1 className="text-2xl font-bold mt-2">PontoWeb Unespar</h1>
              <div className="flex flex-col items-center mt-1 mb-1">
                <span className="text-4xl font-mono font-bold tracking-widest drop-shadow-md">
                  {currentTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                </span>
                <span className="text-xs text-green-100 uppercase tracking-wide font-medium mt-1">
                  {currentTime.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}
                </span>
              </div>
              <div className="flex justify-center items-center gap-2 text-sm opacity-90 mt-2 bg-green-700/30 py-1 px-3 rounded-full inline-flex">
                <div className="flex items-center gap-1">
                   {notifConfig.enabled && <Icon.Zap />}
                   <Icon.Map /> 
                </div>
                {status === 'loading' || status === 'locating' ? 'A procurar GPS...' : status === 'error' ? 'GPS Indispon√≠vel' : 'Localiza√ß√£o Ativa'}
              </div>
            </div>

            {status === 'sending' && <div className="absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm fade-in"><div className="spinner mb-4"></div><p className="text-green-700 font-bold animate-pulse">A enviar dados...</p></div>}

            <div className="flex-1 p-6 flex flex-col justify-center gap-4">
              <div className="text-center mb-2">
                <p className="text-gray-500 text-xs uppercase tracking-wider mb-1">Bolsista Identificado</p>
                <h3 className="text-xl font-bold text-gray-800">{bolsistaName || 'A carregar...'}</h3>
                {entryTime && <div className="mt-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-bold inline-block">Entrada √†s: {entryTime}</div>}
              </div>
              
              <button disabled={status!=='ready'} onClick={() => startCamera('Entrada')} className="bg-green-50 text-green-700 border-2 border-green-200 p-5 rounded-2xl font-bold text-xl hover:bg-green-100 hover:border-green-300 transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 disabled:bg-gray-100 disabled:border-gray-200 disabled:text-gray-400 shadow-sm">
                ENTRADA
              </button>
              <button disabled={status!=='ready'} onClick={() => startCamera('Saida')} className="bg-red-50 text-red-700 border-2 border-red-200 p-5 rounded-2xl font-bold text-xl hover:bg-red-100 hover:border-red-300 transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm">
                SA√çDA
              </button>
              <div className="grid grid-cols-2 gap-4 mt-2">
                <button disabled={status!=='ready'} onClick={() => startCamera('Intervalo-Inicio')} className="bg-gray-50 text-gray-700 p-4 rounded-xl font-bold border-2 border-gray-100 hover:border-gray-300 hover:bg-gray-100 active:scale-95 disabled:opacity-50">In√≠cio Interv.</button>
                <button disabled={status!=='ready'} onClick={() => startCamera('Intervalo-Fim')} className="bg-gray-50 text-gray-700 p-4 rounded-xl font-bold border-2 border-gray-100 hover:border-gray-300 hover:bg-gray-100 active:scale-95 disabled:opacity-50">Fim Interv.</button>
              </div>
            </div>
            
            <div className="p-6 text-center border-t border-gray-100 mt-2">
               <div className="text-[10px] text-gray-500 mb-1 flex flex-col items-center justify-center gap-1 opacity-80">
                 <div className="flex items-center gap-1"><Icon.Lock /><span className="font-semibold">Privacidade e Seguran√ßa</span></div>
                 <span className="leading-tight max-w-[280px]">Este aplicativo atende e respeita as normas da Pol√≠tica de Privacidade e Prote√ß√£o de Dados (LGPD).</span>
               </div>
               <div className="text-[9px] text-gray-300 mt-2 font-mono">Vers√£o 4.2 (Keep Alive)</div>
            </div>

            {/* MODAL CONFIGURA√á√ïES */}
            {settingsOpen && (
              <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center z-50 fade-in">
                <div className="bg-white w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Icon.Bell /> Lembretes</h3>
                    <button onClick={() => setSettingsOpen(false)} className="text-gray-400 text-2xl">&times;</button>
                  </div>
                  
                  {!notifConfig.enabled ? (
                    <div className="text-center py-6">
                       <p className="text-sm text-gray-600 mb-4 px-4">Ative os alertas para n√£o perder o hor√°rio de entrada e sa√≠da.</p>
                       <button onClick={enableAlerts} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow hover:bg-blue-700">Ativar Alertas</button>
                    </div>
                  ) : (
                    <form onSubmit={saveSettings} className="space-y-4">
                      <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Seu Hor√°rio de Entrada</label>
                        <input type="time" name="entryTime" defaultValue={notifConfig.entryTimeStr} className="w-full p-3 bg-gray-50 border rounded-xl font-bold text-center text-lg outline-none focus:border-green-500"/>
                      </div>
                      <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Avisar anteced√™ncia (minutos)</label>
                        <input type="number" name="reminderMins" defaultValue={notifConfig.reminderMins} min="1" max="60" className="w-full p-3 bg-gray-50 border rounded-xl font-bold text-center text-lg outline-none focus:border-green-500"/>
                      </div>
                      
                      <button type="button" onClick={testNotification} className="w-full py-2 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 flex items-center justify-center gap-2 text-sm">
                        üîî Testar Notifica√ß√£o Agora
                      </button>

                      <div className="bg-green-50 p-3 rounded-lg text-xs text-green-800 border border-green-200 flex items-center gap-2">
                        <Icon.Zap /> <strong>Modo Sentinela Ativo:</strong> O app rodar√° em segundo plano (pode consumir mais bateria).
                      </div>
                      <button type="submit" className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow hover:bg-green-700">Salvar Prefer√™ncias</button>
                    </form>
                  )}
                </div>
              </div>
            )}

          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<TimeClock />);
    </script>
  </body>
</html>
