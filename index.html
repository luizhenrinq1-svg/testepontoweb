<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoWeb</title>
    
    <!-- PWA Config -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2983/2983818.png">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { background-color: #f0fdf4; color: #166534; font-family: sans-serif; user-select: none; }
      .spinner { border: 4px solid #dcfce7; width: 40px; height: 40px; border-radius: 50%; border-left-color: #16a34a; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .bell-shake { animation: shake 2s infinite; transform-origin: top center; }
      @keyframes shake { 0% { transform: rotate(0deg); } 10% { transform: rotate(10deg); } 20% { transform: rotate(-10deg); } 30% { transform: rotate(6deg); } 40% { transform: rotate(-6deg); } 50% { transform: rotate(0deg); } 100% { transform: rotate(0deg); } }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // === CONFIGURA√á√ÉO ===
      const API_URL = "https://script.google.com/macros/s/AKfycbz7poveyTAAUUdqi1fWEgGTE3eRXWqizE3n5Dx0fMkkMdAsWp-Q_PYrSh7EzO07dXydVA/exec"; 
      // ====================

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          if (!API_URL.startsWith('http')) throw new Error("URL da API n√£o configurada no index.html");
          const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
          const json = await response.json();
          if (json.error) throw new Error(json.error);
          return json;
        }
      };

      if (typeof google === 'undefined') {
        const createRunner = (success, failure) => {
          return {
            withSuccessHandler: (fn) => createRunner(fn, failure),
            withFailureHandler: (fn) => createRunner(success, fn),
            getBolsistaInfo: (id, token) => ExternalBridge.request('getBolsistaInfo', { id, token }).then(success).catch(failure || console.error),
            registrarPonto: (payload) => ExternalBridge.request('registrarPonto', payload).then(success).catch(failure || console.error)
          };
        };
        window.google = { script: { run: createRunner() } };
      }

      const Icon = {
        Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Camera: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
        Check: () => <svg className="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
        Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
      };

      function TimeClock() {
        const [params, setParams] = useState(null);
        const [bolsistaName, setBolsistaName] = useState('');
        const [lastAction, setLastAction] = useState(null);
        const [entryTime, setEntryTime] = useState(null);
        const [targetHours, setTargetHours] = useState(4); 
        const [status, setStatus] = useState('loading');
        const [location, setLocation] = useState(null);
        const [punchType, setPunchType] = useState(null);
        const [result, setResult] = useState(null);
        const [currentTime, setCurrentTime] = useState(new Date()); 
        
        const [settingsOpen, setSettingsOpen] = useState(false);
        const [notifConfig, setNotifConfig] = useState({ enabled: false, entryTimeStr: '08:00', reminderMins: 10 });
        const [swReg, setSwReg] = useState(null);
        const [installPrompt, setInstallPrompt] = useState(null);

        const videoRef = useRef(null);
        const lastNotifRef = useRef(null); 
        const wakeLockRef = useRef(null);

        // --- PWA & SW SETUP ---
        useEffect(() => {
          // 1. Tenta Registrar Service Worker Real
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
              .then(reg => { console.log('SW OK'); setSwReg(reg); })
              .catch(err => console.log('SW Fail', err));
          }

          // 2. Captura evento de instala√ß√£o (PWA)
          window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            setInstallPrompt(e);
          });

          // 3. Load Config
          const saved = localStorage.getItem('pontoWebConfig');
          if (saved) {
            const cfg = JSON.parse(saved);
            setNotifConfig(prev => ({...prev, ...cfg}));
            if(cfg.enabled) requestWakeLock();
          }
        }, []);

        // --- LOOP DE TEMPO ---
        useEffect(() => {
          const timer = setInterval(() => setCurrentTime(new Date()), 1000);
          const notifTimer = setInterval(checkNotifications, 10000); // 10s
          return () => { clearInterval(timer); clearInterval(notifTimer); releaseWakeLock(); };
        }, [notifConfig, entryTime, lastAction, targetHours, swReg]);

        const requestWakeLock = async () => {
          if ('wakeLock' in navigator) {
             try { wakeLockRef.current = await navigator.wakeLock.request('screen'); } catch(e){}
          }
        };
        const releaseWakeLock = () => {
          if(wakeLockRef.current) { wakeLockRef.current.release(); wakeLockRef.current = null; }
        };

        // --- DATA LOADING ---
        useEffect(() => {
          const u = new URLSearchParams(window.location.search);
          const id = u.get('id');
          const token = u.get('token');
          if(id && token) {
            setParams({ id, token });
            google.script.run.withSuccessHandler(res => {
               if(res.nome) setBolsistaName(res.nome);
               if(res.entryTime) setEntryTime(res.entryTime);
               if(res.lastAction) setLastAction(res.lastAction);
               if(res.horasDia) setTargetHours(Number(res.horasDia));
               setStatus('ready');
            }).getBolsistaInfo(id, token);
            navigator.geolocation.getCurrentPosition(p => setLocation(p.coords), () => {}, {enableHighAccuracy:true});
          } else {
             setStatus('no-link');
          }
        }, []);

        // --- NOTIFICA√á√ïES NATIVAS (Service Worker) ---
        const triggerNotification = (title, body) => {
           const now = Date.now();
           if (lastNotifRef.current && lastNotifRef.current.body === body && (now - lastNotifRef.current.time < 300000)) return;
           lastNotifRef.current = { body, time: now };

           // Tocar Som
           if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
           new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play().catch(()=>{});

           // Disparar via SW (Barra de Status)
           if (Notification.permission === 'granted' && swReg) {
             swReg.showNotification(title, {
               body,
               icon: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png',
               badge: 'https://cdn-icons-png.flaticon.com/512/2983/2983818.png',
               vibrate: [300, 100, 400],
               tag: 'pontoweb',
               renotify: true,
               requireInteraction: true
             });
           } else {
             alert(`‚ö†Ô∏è ${title}\n${body}`); // Fallback
           }
        };

        const checkNotifications = () => {
          if (!notifConfig.enabled || !targetHours) return;
          const now = new Date();
          const totalCurrentMins = now.getHours() * 60 + now.getMinutes();

          if(!notifConfig.entryTimeStr) return;
          const [confH, confM] = notifConfig.entryTimeStr.split(':').map(Number);
          const totalConfigMins = confH * 60 + confM;
          
          if (!lastAction && totalCurrentMins === (totalConfigMins - notifConfig.reminderMins)) {
             triggerNotification("LEMBRETE PONTO", `Faltam ${notifConfig.reminderMins} minutos.`);
          }
          if (!lastAction && totalCurrentMins === (totalConfigMins + 5)) {
             triggerNotification("ATEN√á√ÉO: ATRASADO", "J√° passaram 5 minutos do hor√°rio!");
          }
          if (entryTime && lastAction !== 'Saida') {
             const [eH, eM] = entryTime.split(':').map(Number);
             const worked = totalCurrentMins - (eH * 60 + eM);
             if (worked === (targetHours * 60)) {
                triggerNotification("META ATINGIDA", `Voc√™ completou ${targetHours} horas.`);
             }
          }
        };

        const enableAlerts = () => {
          Notification.requestPermission().then(perm => {
             if(perm === 'granted') {
               setNotifConfig(prev => ({...prev, enabled: true}));
               requestWakeLock();
               triggerNotification("PontoWeb", "Notifica√ß√µes Ativadas na Barra de Status!");
             } else {
               alert("Permiss√£o bloqueada nas configura√ß√µes do site.");
             }
          });
        };

        const installPWA = () => {
           if(installPrompt) {
              installPrompt.prompt();
              installPrompt.userChoice.then(res => setInstallPrompt(null));
           } else {
              alert("Para instalar: Toque no menu do navegador e 'Adicionar √† Tela Inicial' ou 'Instalar App'.");
           }
        };

        // --- UI ---
        const startCamera = async (type) => {
          setPunchType(type); setStatus('punching');
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            if (videoRef.current) videoRef.current.srcObject = stream;
          } catch(e) { alert('Erro: C√¢mera necess√°ria.'); setStatus('ready'); }
        };

        const confirm = () => {
          const canvas = document.createElement('canvas'); canvas.width = 320; canvas.height = 240;
          const ctx = canvas.getContext('2d');
          if (videoRef.current) {
             ctx.drawImage(videoRef.current, 0, 0, 320, 240);
             videoRef.current.srcObject.getTracks().forEach(t => t.stop());
          }
          setStatus('sending');
          google.script.run.withSuccessHandler((res) => {
             if(res.ok) { setResult(res); setStatus('success'); } else { alert(res.msg); setStatus('ready'); }
          }).registrarPonto({
             pessoaId: params.id, token: params.token, tipo: punchType,
             lat: location?.latitude, lng: location?.longitude, prec: location?.accuracy, 
             fotoBase64: canvas.toDataURL('image/jpeg', 0.7)
          });
        };

        // Renders
        if (status === 'no-link') return <div className="h-screen flex items-center justify-center text-red-600 font-bold">Link Inv√°lido</div>;
        if (status === 'success') return <div className="h-screen flex flex-col items-center justify-center bg-white p-6 text-center"><Icon.Check /><h2 className="text-2xl font-bold mt-4 text-green-700">Registrado!</h2><p className="mt-2">{result.timestamp}</p><button onClick={()=>{setStatus('ready');setResult(null);}} className="mt-8 bg-green-100 text-green-800 px-6 py-2 rounded-full font-bold">Voltar</button></div>;
        if (status === 'punching') return <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-50"><video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover opacity-80"></video><div className="absolute bottom-10 w-full px-6 flex gap-4"><button onClick={()=>{videoRef.current?.srcObject?.getTracks().forEach(t=>t.stop());setStatus('ready')}} className="flex-1 bg-white py-4 rounded-xl font-bold">Cancelar</button><button onClick={confirm} className="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold">Confirmar</button></div></div>;

        return (
          <div className="min-h-screen max-w-md mx-auto bg-white shadow-xl flex flex-col relative">
             <div className="bg-green-600 p-6 text-white text-center rounded-b-3xl shadow-lg relative">
                <div className="absolute top-4 left-4 cursor-pointer" onClick={installPWA}>
                   <div className="bg-green-700/50 p-2 rounded-full text-xs flex items-center gap-1 hover:bg-green-500">
                     <span>üì≤</span> {installPrompt ? 'Instalar App' : 'App PWA'}
                   </div>
                </div>
                <button onClick={() => setSettingsOpen(true)} className={`absolute top-4 right-4 bg-green-700/50 p-2 rounded-full ${notifConfig.enabled ? 'bell-shake' : ''}`}><Icon.Bell /></button>
                <h1 className="text-2xl font-bold mt-4">PontoWeb</h1>
                <div className="text-4xl font-mono font-bold mt-2">{currentTime.toLocaleTimeString('pt-BR')}</div>
             </div>

             <div className="flex-1 p-6 flex flex-col justify-center gap-4">
                <div className="text-center mb-2"><h3 className="text-xl font-bold text-gray-800">{bolsistaName || 'Carregando...'}</h3></div>
                <button disabled={status!=='ready'} onClick={() => startCamera('Entrada')} className="bg-green-50 text-green-700 border-2 border-green-200 p-5 rounded-2xl font-bold text-xl active:scale-95 disabled:opacity-50">ENTRADA</button>
                <button disabled={status!=='ready'} onClick={() => startCamera('Saida')} className="bg-red-50 text-red-700 border-2 border-red-200 p-5 rounded-2xl font-bold text-xl active:scale-95 disabled:opacity-50">SA√çDA</button>
             </div>

             {settingsOpen && (
               <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
                 <div className="bg-white w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl">
                    <div className="flex justify-between mb-4"><h3 className="font-bold">Lembretes</h3><button onClick={()=>setSettingsOpen(false)}>‚úï</button></div>
                    {!notifConfig.enabled ? (
                       <button onClick={enableAlerts} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Ativar Notifica√ß√µes</button>
                    ) : (
                       <div className="space-y-4">
                          <input type="time" onChange={e=>setNotifConfig({...notifConfig, entryTimeStr: e.target.value})} value={notifConfig.entryTimeStr} className="w-full p-3 border rounded-xl text-center font-bold"/>
                          <button onClick={()=>{triggerNotification("Teste", "Funcionando na Barra!")}} className="w-full py-2 bg-gray-200 font-bold rounded-lg">üîî Testar Agora</button>
                          <button onClick={()=>{localStorage.setItem('pontoWebConfig', JSON.stringify(notifConfig)); setSettingsOpen(false);}} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Salvar</button>
                       </div>
                    )}
                 </div>
               </div>
             )}
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<TimeClock />);
    </script>
  </body>
</html>
